<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>架電ナビ | MIXED株式会社</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5fb4;
            --primary-light: #3584e4;
            --secondary: #e01b24;
            --accent-yellow: #f5c211;
            --accent-green: #26a269;
            --accent-purple: #9141ac;
            --bg-main: #f6f5f4;
            --bg-white: #ffffff;
            --text-dark: #241f31;
            --text-gray: #5e5c64;
            --border: #deddda;
            --shadow: rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-main);
            color: var(--text-dark);
            line-height: 1.7;
            font-size: 16px;
            min-height: 100vh;
        }

        /* ========== パスワード保護画面 ========== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a5fb4 0%, #3584e4 50%, #62a0ea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 90%;
            max-width: 380px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 8px 20px rgba(26, 95, 180, 0.3);
        }

        .login-company {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .login-title {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 2rem;
        }

        .login-input-group {
            margin-bottom: 1rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 180, 0.1);
        }

        .login-input.error {
            border-color: var(--secondary);
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 180, 0.4);
        }

        .login-error {
            color: var(--secondary);
            font-size: 0.85rem;
            margin-top: 1rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .app-content {
            display: none;
        }

        .app-content.visible {
            display: block;
        }

        /* ========== ヘッダー ========== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* ページ切り替えタブ */
        .page-tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .page-tab {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .page-tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .page-tab.active {
            background: white;
            color: var(--primary);
        }

        /* ========== 架電者選択画面 ========== */
        .caller-select-screen {
            display: none;
            padding: 1rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .caller-select-screen.visible {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .caller-select-card {
            background: white;
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .caller-select-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .caller-select-subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 1.5rem;
        }

        .caller-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .caller-btn {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .caller-btn:hover {
            border-color: var(--primary);
            background: #f0f6ff;
        }

        .caller-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .caller-btn.add-new {
            border-style: dashed;
            color: var(--text-gray);
        }

        .caller-btn.add-new:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .caller-input-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .start-call-btn {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1.5rem;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .start-call-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(38, 162, 105, 0.4);
        }

        .start-call-btn:disabled {
            background: var(--border);
            color: var(--text-gray);
            cursor: not-allowed;
        }

        /* 会社名入力グループ */
        .company-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .company-input-group select {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Noto Sans JP', sans-serif;
            background: white;
        }

        .company-input-group select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .company-input-group #companyTypeSelect {
            flex: 0 0 auto;
            min-width: 100px;
        }

        .company-input-group #companyTypePosition {
            flex: 0 0 auto;
            width: 60px;
        }

        .company-input-group #companyNameInput {
            flex: 1;
            min-width: 120px;
        }

        /* 架電者ボタンの削除機能 */
        .caller-btn {
            position: relative;
        }

        .caller-btn .delete-icon {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            z-index: 1;
        }

        .caller-btn:hover .delete-icon {
            opacity: 1;
        }

        .caller-btn.add-new .delete-icon {
            display: none;
        }

        /* 架電情報ヘッダー */
        .call-info-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a56db 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .call-info-header .company-name {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .call-info-header .call-meta {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* 自動入力済み表示 */
        .auto-filled-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .auto-filled-section h4 {
            color: var(--primary);
            margin: 0 0 0.75rem 0;
            font-size: 0.9rem;
        }

        .auto-filled-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e0e7ff;
            font-size: 0.95rem;
        }

        .auto-filled-item:last-child {
            border-bottom: none;
        }

        .auto-filled-item .label {
            color: var(--text-gray);
            min-width: 80px;
        }

        .auto-filled-item .value {
            color: var(--text-dark);
            font-weight: 600;
        }

        .auto-filled-item .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .auto-filled-item .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* ========== 進捗バー（改善版） ========== */
        .progress-container {
            background: var(--bg-white);
            padding: 1rem 1rem 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .progress-phase {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .progress-phase-icon {
            font-size: 1.2rem;
        }

        .progress-phase-text {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-task {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: #f0f6ff;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .progress-task strong {
            color: var(--text-dark);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .step-label {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .step-remaining {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .progress-bar {
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent-green) 100%);
            border-radius: 6px;
            transition: width 0.4s ease;
        }

        /* ========== メインコンテンツ ========== */
        .main {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 160px;
        }

        /* ステップカード */
        .step-card {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 15px var(--shadow);
            animation: stepFadeIn 0.3s ease-out;
        }

        @keyframes stepFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-card.hidden {
            display: none;
        }

        /* ========== トークスクリプト（読み上げ部分）========== */
        .talk-script {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 16px;
            padding: 1.25rem;
            margin: 1rem 0;
            position: relative;
        }

        .talk-script-label {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            position: absolute;
            top: -10px;
            left: 1rem;
        }

        .talk-script-content {
            font-size: 1.1rem;
            line-height: 1.9;
            color: var(--text-dark);
            padding-top: 0.5rem;
        }

        .talk-script-content .highlight {
            background: linear-gradient(transparent 60%, #fef08a 60%);
            font-weight: 700;
            padding: 0 2px;
        }

        .talk-script-content ruby {
            ruby-position: over;
        }

        .talk-script-content rt {
            font-size: 0.6rem;
            color: var(--text-gray);
        }

        /* ========== フローティング困ったボタン ========== */
        .floating-help-btn {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(238, 90, 36, 0.4);
            z-index: 98;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(238, 90, 36, 0.5);
        }

        .floating-help-btn:active {
            transform: scale(0.95);
        }

        .floating-help-btn.hidden {
            display: none;
        }

        /* ヘルプパネル */
        .help-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 60vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .help-panel.show {
            transform: translateY(0);
        }

        .help-panel-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .help-panel-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .help-panel-close {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .help-panel-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .help-panel-buttons {
            display: grid;
            gap: 0.75rem;
        }

        .step-title {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
        }

        /* トーク表示エリア */
        .talk-display {
            background: #f8f7f6;
            border-left: 4px solid var(--primary);
            padding: 1.2rem;
            margin: 1rem 0;
            border-radius: 0 12px 12px 0;
            font-size: 1.05rem;
            line-height: 1.9;
        }

        .talk-display .highlight {
            background: linear-gradient(transparent 60%, #fef08a 60%);
            font-weight: 500;
        }

        .talk-display.warning {
            border-left-color: var(--accent-yellow);
            background: #fffbeb;
        }

        .talk-display.tip {
            border-left-color: var(--accent-green);
            background: #f4fbf7;
        }

        .talk-note {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 0.5rem;
        }

        /* 選択肢ボタン */
        .choices {
            display: grid;
            gap: 0.875rem;
            margin: 1.5rem 0;
        }

        .choices.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .choice-btn {
            min-height: 60px;
            padding: 1rem;
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.15s ease-out;
            text-align: center;
            font-family: 'Noto Sans JP', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .choice-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(26, 95, 180, 0.15);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .choice-btn:hover {
            border-color: var(--primary);
            background: #f0f6ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .choice-btn:active {
            transform: scale(0.95) translateY(0);
            box-shadow: none;
            transition: transform 0.1s;
        }

        .choice-btn:active::after {
            width: 250px;
            height: 250px;
        }

        .choice-btn .recommend-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--accent-yellow);
            color: #5d4e00;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 0 12px 0 8px;
        }

        .choice-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(26, 95, 180, 0.3);
        }

        .choice-btn.primary:hover {
            box-shadow: 0 6px 20px rgba(26, 95, 180, 0.4);
            background: linear-gradient(135deg, #1557a0 0%, var(--primary) 100%);
        }

        .choice-btn.primary:hover {
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.4);
        }

        .choice-btn.success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
            color: white;
            border: none;
        }

        .choice-btn.warning {
            background: linear-gradient(135deg, #e5a50a 0%, var(--accent-yellow) 100%);
            color: white;
            border: none;
        }

        .choice-btn.danger {
            background: linear-gradient(135deg, #c01c28 0%, var(--secondary) 100%);
            color: white;
            border: none;
        }

        .choice-btn .btn-sub {
            display: block;
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }

        /* 切り返しヘルプエリア */
        .help-area {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border);
        }

        .help-title {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 0.75rem;
        }

        .help-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .help-btn {
            padding: 0.6rem 1rem;
            background: #fff5f5;
            border: 1px solid #ffe0e0;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .help-btn:hover {
            background: #ffe0e0;
        }

        /* ========== モーダル ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-white);
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            cursor: default;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 700;
            flex: 1;
        }

        .modal-close {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            min-width: 50px;
            min-height: 50px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.75rem;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        .modal-close:active {
            transform: scale(0.9);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            background: var(--bg-main);
        }

        .modal-close-btn {
            width: 100%;
            min-height: 54px;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .modal-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.4);
        }

        .modal-close-btn:active {
            transform: scale(0.98);
        }

        .modal-action-link {
            display: block;
            text-align: center;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            width: 100%;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .modal-action-link:hover {
            box-shadow: 0 4px 15px rgba(38, 162, 105, 0.4);
        }

        .modal-talk {
            background: #f8f7f6;
            border-left: 4px solid var(--accent-green);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        .modal-talk .highlight {
            background: linear-gradient(transparent 60%, #fef08a 60%);
            font-weight: 500;
        }

        .modal-note {
            font-size: 0.85rem;
            color: var(--text-gray);
            padding: 0.75rem;
            background: #fffbeb;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        /* ========== ナビゲーションバー ========== */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--bg-white) 0%, var(--bg-white) 90%, rgba(255,255,255,0.9) 100%);
            border-top: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            z-index: 99;
            box-shadow: 0 -4px 20px var(--shadow);
        }

        .nav-btn {
            min-width: 120px;
            min-height: 52px;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-btn.back {
            background: linear-gradient(135deg, #5e5c64 0%, #77767b 100%);
            color: white;
            flex: 1;
        }

        .nav-btn.back:hover {
            background: linear-gradient(135deg, #4a484d 0%, #5e5c64 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .nav-btn.back:disabled {
            background: var(--border);
            color: var(--text-gray);
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn.forward {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            flex: 1;
        }

        .nav-btn.forward:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 95, 180, 0.4);
        }

        .nav-btn.forward:disabled {
            background: var(--border);
            color: var(--text-gray);
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn.reset {
            min-width: auto;
            padding: 0.75rem;
            background: rgba(224, 27, 36, 0.1);
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .nav-btn.reset:hover {
            background: rgba(224, 27, 36, 0.2);
        }

        .btn-count {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-left: 0.25rem;
        }

        @media (max-width: 400px) {
            .nav-btn {
                min-width: 90px;
                font-size: 1rem;
                padding: 0.75rem 1rem;
            }
            .nav-btn.reset {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
        }

        /* ========== 終了画面 ========== */
        .end-screen {
            text-align: center;
            padding: 2rem 1rem;
        }

        .end-screen.success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
            color: white;
            border-radius: 16px;
        }

        .end-screen .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .end-screen h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .checklist {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
        }

        .checklist-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .end-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .end-btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .end-btn.primary {
            background: white;
            color: var(--accent-green);
        }

        .end-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* トークパターン切り替え */
        .pattern-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .pattern-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .pattern-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pattern-content {
            display: none;
        }

        .pattern-content.active {
            display: block;
        }

        /* ========== 確認モーダル ========== */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .confirm-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirm-box {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 360px;
            padding: 2rem 1.5rem;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .confirm-modal.show .confirm-box {
            transform: scale(1);
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .confirm-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .confirm-message {
            font-size: 0.95rem;
            color: var(--text-gray);
            margin-bottom: 1.5rem;
        }

        .confirm-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .confirm-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: var(--bg-main);
            color: var(--text-dark);
        }

        .confirm-btn.danger {
            background: linear-gradient(135deg, var(--secondary) 0%, #c71c1c 100%);
            color: white;
        }

        /* ========== チュートリアル ========== */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .tutorial-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .tutorial-card {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .tutorial-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .tutorial-legend {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .tutorial-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-main);
            border-radius: 10px;
        }

        .tutorial-color {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .tutorial-color.blue {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .tutorial-color.green {
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
        }

        .tutorial-color.red {
            background: linear-gradient(135deg, var(--secondary) 0%, #c71c1c 100%);
        }

        .tutorial-color.white {
            background: white;
            border: 2px solid var(--border);
        }

        .tutorial-text {
            font-size: 0.9rem;
        }

        .tutorial-close-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* スマホ対応 */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.1rem;
            }

            .choices.two-col {
                grid-template-columns: 1fr;
            }

            .choice-btn {
                padding: 1rem;
            }

            .login-box {
                padding: 2rem 1.5rem;
            }

            .login-logo {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }
        }

        /* ========== 架電ログ機能 ========== */
        .log-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 101;
            background: linear-gradient(135deg, var(--accent-purple) 0%, #c061cb 100%);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(145, 65, 172, 0.3);
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .log-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(145, 65, 172, 0.4);
        }

        .log-btn .badge {
            background: white;
            color: var(--accent-purple);
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 0.3rem;
        }

        /* 架電開始フォーム */
        .call-start-form {
            background: linear-gradient(135deg, #f0f6ff 0%, #e8f5e9 100%);
            border: 2px solid var(--primary-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .call-start-form h3 {
            color: var(--primary);
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            margin-bottom: 1rem;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.4rem;
        }

        .form-label .required {
            color: var(--secondary);
            margin-left: 0.25rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 180, 0.1);
        }

        .form-row-inline {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .form-row-inline .form-input {
            flex: 1;
        }

        .form-btn-small {
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-btn-small.add {
            background: var(--accent-green);
            color: white;
        }

        .form-btn-small.delete {
            background: var(--secondary);
            color: white;
        }

        /* チェックボックス・ラジオ */
        .form-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .form-checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .form-checkbox-label:has(input:checked) {
            border-color: var(--primary);
            background: #f0f6ff;
        }

        .form-checkbox-label input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* ログ一覧モーダル */
        .log-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .log-list-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .log-list-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--bg-white);
            border-radius: 20px;
            overflow: hidden;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .log-list-modal.show .log-list-container {
            transform: translate(-50%, -50%) scale(1);
        }

        .log-list-header {
            background: linear-gradient(135deg, var(--accent-purple) 0%, #c061cb 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-list-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .log-list-close {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .log-list-toolbar {
            padding: 0.75rem 1rem;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .log-filter-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
        }

        .log-list-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .log-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .log-item-date {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .log-item-result {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-weight: 700;
        }

        .log-item-result.success {
            background: #d3f9d8;
            color: #1b5e20;
        }

        .log-item-result.recall {
            background: #fff3e0;
            color: #ef6c00;
        }

        .log-item-result.not-target {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .log-item-company {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .log-item-caller {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .log-list-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .log-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .log-action-btn.download {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .log-action-btn.delete-all {
            background: rgba(224, 27, 36, 0.1);
            color: var(--secondary);
        }

        /* ログ詳細モーダル */
        .log-detail-content {
            padding: 1.5rem;
        }

        .log-detail-section {
            margin-bottom: 1.5rem;
        }

        .log-detail-section h4 {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }

        .log-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.95rem;
        }

        .log-detail-row .label {
            color: var(--text-gray);
        }

        .log-detail-row .value {
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }

        .log-detail-memo {
            background: var(--bg-main);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .log-detail-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .log-detail-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .log-detail-btn.image {
            background: linear-gradient(135deg, var(--accent-green) 0%, #2ec27e 100%);
            color: white;
        }

        .log-detail-btn.delete {
            background: rgba(224, 27, 36, 0.1);
            color: var(--secondary);
        }

        /* 画像出力用のキャプチャエリア（非表示） */
        .log-capture {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 400px;
            background: white;
            padding: 1.5rem;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .log-capture-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .log-capture-header h2 {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .log-capture-header .date {
            color: var(--text-gray);
            font-size: 0.85rem;
        }

        .log-capture-body {
            font-size: 0.9rem;
        }

        .log-capture-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dotted var(--border);
        }

        .log-capture-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--primary);
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .empty-logs {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-gray);
        }

        .empty-logs .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 600px) {
            .log-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- パスワード保護画面 -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">🎯</div>
            <div class="login-company">MIXED株式会社</div>
            <div class="login-title">架電ナビ</div>
            <div class="login-input-group">
                <input type="password" id="passwordInput" class="login-input" placeholder="パスワードを入力" autocomplete="off">
            </div>
            <button id="loginBtn" class="login-btn">ログイン</button>
            <div id="loginError" class="login-error">パスワードが正しくありません</div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="appContent" class="app-content">
        <header class="header">
            <div class="header-top">
                <h1>🎯 架電ナビ</h1>
            </div>
            <div class="page-tabs">
                <a href="index.html" class="page-tab">📖 マニュアル</a>
                <a href="navi.html" class="page-tab active">🎯 架電ナビ</a>
            </div>
        </header>

        <!-- 架電者選択画面 -->
        <div class="caller-select-screen" id="callerSelectScreen">
            <div class="caller-select-card">
                <div class="caller-select-title">📞 架電を開始する</div>
                <div class="caller-select-subtitle">架電者を選択し、会社情報を入力してください</div>

                <label class="form-label">架電者を選択<span class="required">*</span></label>
                <div class="caller-buttons" id="callerButtons">
                    <!-- 動的に生成 -->
                </div>

                <div class="caller-input-section">
                    <div class="form-row">
                        <label class="form-label">会社名<span class="required">*</span></label>
                        <div class="company-input-group">
                            <select id="companyTypeSelect" onchange="updateStartButton()">
                                <option value="">なし</option>
                                <option value="株式会社">株式会社</option>
                                <option value="有限会社">有限会社</option>
                                <option value="合同会社">合同会社</option>
                                <option value="合資会社">合資会社</option>
                                <option value="個人事業主">個人事業主</option>
                            </select>
                            <select id="companyTypePosition">
                                <option value="before">前</option>
                                <option value="after">後</option>
                            </select>
                            <input type="text" class="form-input" id="companyNameInput" placeholder="会社名">
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">電話番号</label>
                        <input type="tel" class="form-input" id="phoneNumberInput" placeholder="例：06-1234-5678">
                    </div>
                </div>

                <button class="start-call-btn" id="startCallBtn" disabled>架電開始 →</button>
            </div>
        </div>

        <!-- ステップ画面 -->
        <div id="stepScreen" style="display: none;">
            <!-- 架電情報ヘッダー -->
            <div class="call-info-header" id="callInfoHeader">
                <div class="company-name">
                    <span>📞</span>
                    <span id="headerCompanyName">会社名</span>
                </div>
                <div class="call-meta" id="headerCallMeta"></div>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-phase">
                    <span class="progress-phase-icon" id="phaseIcon">📍</span>
                    <span class="progress-phase-text" id="phaseText">導入フェーズ</span>
                </div>
                <div class="progress-task" id="progressTask">
                    <strong>今やること:</strong> <span id="taskText">受付を突破する</span>
                </div>
                <div class="progress-info">
                    <span class="step-label" id="stepLabel">STEP 1（残り約9画面）</span>
                    <span class="step-remaining" id="stepRemaining"></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 10%"></div>
                </div>
            </div>

            <main class="main" id="mainContent">
                <!-- ステップはJavaScriptで動的に生成 -->
            </main>
        </div>

        <!-- フローティング困ったボタン -->
        <button class="floating-help-btn hidden" id="floatingHelpBtn">🆘</button>

        <!-- ヘルプパネル -->
        <div class="help-panel" id="helpPanel">
            <div class="help-panel-header">
                <h3>🆘 困ったときの切り返し</h3>
                <button class="help-panel-close" id="helpPanelClose">×</button>
            </div>
            <div class="help-panel-body">
                <div class="help-panel-buttons" id="helpPanelButtons">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <nav class="nav-bar" id="navBar" style="display: none;">
            <button class="nav-btn back" id="backBtn" disabled>← 戻る</button>
            <button class="nav-btn reset" id="resetBtn">🔄 最初から</button>
            <button class="nav-btn forward" id="forwardBtn" disabled>進む →</button>
        </nav>
    </div>

    <!-- 確認モーダル -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-box">
            <div class="confirm-icon" id="confirmIcon">⚠️</div>
            <div class="confirm-title" id="confirmTitle">確認</div>
            <div class="confirm-message" id="confirmMessage">本当に終了しますか？</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">いいえ</button>
                <button class="confirm-btn danger" id="confirmOk">はい</button>
            </div>
        </div>
    </div>

    <!-- チュートリアル -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-card">
            <div class="tutorial-title">ボタンの色の意味</div>
            <div class="tutorial-legend">
                <div class="tutorial-item">
                    <div class="tutorial-color blue"></div>
                    <div class="tutorial-text"><strong>青色</strong> = おすすめ・次に進む</div>
                </div>
                <div class="tutorial-item">
                    <div class="tutorial-color green"></div>
                    <div class="tutorial-text"><strong>緑色</strong> = 成功・良い反応</div>
                </div>
                <div class="tutorial-item">
                    <div class="tutorial-color red"></div>
                    <div class="tutorial-text"><strong>赤色</strong> = 終了・注意が必要</div>
                </div>
                <div class="tutorial-item">
                    <div class="tutorial-color white"></div>
                    <div class="tutorial-text"><strong>白色</strong> = その他の選択肢</div>
                </div>
            </div>
            <button class="tutorial-close-btn" id="tutorialClose">わかりました</button>
        </div>
    </div>

    <!-- モーダル -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">切り返しトーク</h3>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 動的に内容を挿入 -->
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn" id="modalCloseBtn">✓ 閉じる</button>
                <button class="modal-action-link" id="modalActionBtn" style="display: none;">🎉 アポ獲得へ進む</button>
            </div>
        </div>
    </div>

    <!-- ログボタン（画面右上固定） -->
    <button class="log-btn" id="logBtn" style="display: none;">
        📋 ログ<span class="badge" id="logBadge">0</span>
    </button>

    <!-- ログ一覧モーダル -->
    <div class="log-list-modal" id="logListModal">
        <div class="log-list-container">
            <div class="log-list-header">
                <h3>📋 架電ログ一覧</h3>
                <button class="log-list-close" id="logListClose">×</button>
            </div>
            <div class="log-list-toolbar">
                <select class="log-filter-select" id="logFilterCaller">
                    <option value="">全ての架電者</option>
                </select>
                <select class="log-filter-select" id="logFilterResult">
                    <option value="">全ての結果</option>
                    <option value="success">アポ獲得</option>
                    <option value="recall">再架電</option>
                    <option value="not-target">対象外</option>
                </select>
                <select class="log-filter-select" id="logFilterDate">
                    <option value="">全期間</option>
                    <option value="today">今日</option>
                    <option value="yesterday">昨日</option>
                    <option value="3days">3日間</option>
                    <option value="week">1週間</option>
                </select>
            </div>
            <div class="log-list-body" id="logListBody">
                <!-- ログ一覧はJavaScriptで動的生成 -->
            </div>
            <div class="log-list-footer">
                <button class="log-action-btn download" id="logDownloadCsv">📥 CSVダウンロード</button>
                <button class="log-action-btn delete-all" id="logDeleteAll">🗑️ 全削除</button>
            </div>
        </div>
    </div>

    <!-- ログ詳細モーダル -->
    <div class="log-list-modal" id="logDetailModal">
        <div class="log-list-container">
            <div class="log-list-header">
                <h3>📄 ログ詳細</h3>
                <button class="log-list-close" id="logDetailClose">×</button>
            </div>
            <div class="log-detail-content" id="logDetailContent">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 画像出力用キャプチャエリア -->
    <div class="log-capture" id="logCapture">
        <div class="log-capture-header">
            <h2>📞 架電記録</h2>
            <div class="date" id="captureDate"></div>
        </div>
        <div class="log-capture-body" id="captureBody">
            <!-- 動的に生成 -->
        </div>
        <div class="log-capture-footer">
            MIXED株式会社 架電ナビ
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // ========== ナビゲーションシステム ==========
        const STEPS = {
            'step1': {
                title: 'STEP 1: 導入（受付突破）',
                name: '導入（受付突破）',
                progress: 10,
                content: `
                    <div class="talk-display">
                        お忙しいところ恐れ入ります。<br>
                        <span class="highlight">グーグルマップ撮影会社 ミックスの○○</span>です。<br><br>
                        〇〇（会社名）の<span class="highlight">代表者様</span>はいらっしゃいますでしょうか？
                    </div>
                    <div class="talk-display warning">
                        <strong>⚠️ ここで会社名をしっかり確認する</strong><br>
                        <span class="talk-note">電話帳の情報と実際の会社名が違う場合があります</span>
                    </div>
                `,
                choices: [
                    { text: '代表者につながった', sub: '→ 時間確認へ', next: 'step2', class: 'primary' },
                    { text: '不在と言われた', sub: '→ 再架電確認', next: 'step1b', class: '' },
                    { text: '何の件？と聞かれた', sub: '→ 切り返し表示', action: 'showHelp', helpId: 'whatCall', class: '' },
                    { text: '営業はいらない', sub: '→ 再架電リストへ', next: 'endRecall', class: 'danger' }
                ],
                helps: [
                    { id: 'whatCall', label: '「何の件？」', title: '「（受付）何の件でしょうか？」への切り返し', content: `
                        <div class="modal-talk">
                            <span class="highlight">グーグル掲載の件</span>になりますので、ご不在でしたらまた改めます。失礼いたします。
                        </div>
                        <div class="modal-note">
                            ※それでもしつこく聞いてくる場合<br>
                            →（企業情報の取り扱いになりまして）代表者様宛の件になりますので、急ぎではないのでまた改めます。失礼いたします。
                        </div>
                    `},
                    { id: 'whatList', label: '「何見てかけてる？」', title: '「何見てかけてるんですか？」への切り返し', content: `
                        <div class="modal-talk">
                            <span class="highlight">電子電話帳から順番に</span>ご連絡させて頂いております。
                        </div>
                        <div class="modal-note">
                            ※「リスト」と言うのはNG！<br>
                            ※非掲載リストの場合：「市外局番から順番にご連絡させて頂いております」
                        </div>
                    `}
                ]
            },
            'step1b': {
                title: 'STEP 1-B: 不在対応',
                name: '不在対応',
                progress: 10,
                content: `
                    <div class="talk-display">
                        グーグル掲載の件でのご連絡になりますが<br>
                        <span class="highlight">お昼か夕方頃</span>には戻られますか？
                    </div>
                    <div class="talk-display warning">
                        <span class="talk-note">※二者択一で聞く（オープンに聞かない）</span>
                    </div>
                `,
                choices: [
                    { text: '時間を教えてくれた', sub: '→ 再架電予約', next: 'endRecallScheduled', class: 'success' },
                    { text: 'わからない/教えてくれない', sub: '→ 終了', next: 'endRecall', class: '' }
                ],
                helps: []
            },
            'step2': {
                title: 'STEP 2: 時間確認',
                name: '時間確認',
                progress: 20,
                content: `
                    <div class="talk-display">
                        Googleマップのお写真の件でお電話させていただいたのですが、<br>
                        <span class="highlight">只今お時間少し大丈夫でしょうか？</span>
                    </div>
                `,
                choices: [
                    { text: '大丈夫/どうぞ', sub: '→ Google案内へ', next: 'step3', class: 'primary' },
                    { text: '今忙しい', sub: '→ 時間確認', action: 'showHelp', helpId: 'busy', class: '' }
                ],
                helps: [
                    { id: 'busy', label: '「今忙しい」', title: '「今忙しい」への対応', content: `
                        <div class="modal-talk">
                            お忙しいところ失礼いたしました。<br>
                            改めてご連絡させていただきたいのですが、<br>
                            <span class="highlight">本日の夕方か、明日</span>のご都合いかがでしょうか？
                        </div>
                        <div class="modal-note">→ 時間を確認して再架電予約へ</div>
                    `}
                ]
            },
            'step3': {
                title: 'STEP 3: Google撮影案内',
                name: 'Google撮影案内',
                progress: 30,
                content: `
                    <div class="talk-display">
                        今グーグルマップに掲載する事業所の写真を<br>
                        順々に撮影しておりまして、もちろん<span class="highlight">無料</span>なのですが、<br>
                        通常通り <span class="highlight">看板や外観だけ</span> の撮影でよろしいでしょうか？<br><br>
                        （内観も希望されますか？）
                    </div>
                `,
                choices: [
                    { text: '外観だけでOK', sub: '→ 電気案内へ', next: 'step4', class: 'primary', track: { photoPreference: '外観のみ' } },
                    { text: '中も撮ってほしい', sub: '→ 電気案内へ', next: 'step4', class: 'success', track: { photoPreference: '外観+内観' } },
                    { text: 'Googleはいらないよ', sub: '→ 別提案へ', next: 'step3b', class: '', track: { photoPreference: 'なし' } },
                    { text: 'それ何？詳しく', sub: '→ 説明表示', action: 'showHelp', helpId: 'whatGoogle', class: '' }
                ],
                helps: [
                    { id: 'whatGoogle', label: '「ストリートビューと違うの？」', title: 'ストリートビューとの違い', content: `
                        <div class="modal-talk">
                            <strong>【ストリートビュー】</strong><br>
                            今、地図の横に建物の目印としてお写真が載っているのですが、そちらは車による通りすがりの自動撮影となります。<br><br>
                            <strong>【インドアビュー（今回）】</strong><br>
                            今回は代表者様お立ち合いの元、お好きな箇所や角度から<span class="highlight">最大8カットまで</span>お撮りさせていただけます♪
                        </div>
                    `},
                    { id: 'whoAreYou', label: '「おたくら何者？」', title: '「おたくら何者なん？」への切り返し', content: `
                        <div class="modal-talk">
                            <span class="highlight">グーグル認定のカメラマンが在籍している撮影会社</span>です。
                        </div>
                    `}
                ]
            },
            'step3b': {
                title: 'STEP 3-B: 別提案（電気・ネット）',
                name: 'Google不要時の提案',
                progress: 30,
                content: `
                    <div class="talk-display">
                        こちらのほかにも弊社さまざまなキャンペーン中でして、<br>
                        <span class="highlight">電力会社さんと通信会社さんにご協賛</span>いただいている中で<br>
                        電気 または お電話回線（インターネット）の<br>
                        <span class="highlight">事業所割引の無料診断</span>受けていただけるキャンペーンのご用意もございます(^^)<br><br>
                        料金をきちんとご説明させていただきまして、<br>
                        お安くなってご納得いただけた場合には、<br>
                        <span class="highlight">キャッシュバックプレゼント</span>もございます♪
                    </div>
                `,
                choices: [
                    { text: '興味ある/聞いてみる', sub: '→ 電力判別へ', next: 'step5', class: 'primary' },
                    { text: 'それもいらない', sub: '→ 終了', next: 'endNotTarget', class: 'danger' },
                    { text: 'CBいくらもらえる？', sub: '→ 切り返し表示', action: 'showHelp', helpId: 'cashback', class: '' }
                ],
                helps: [
                    { id: 'cashback', label: '「CBいくら？」', title: '「キャッシュバックいくらもらえる？」', content: `
                        <div class="modal-talk">
                            ご利用状況や月々の使用量によって変わってきますが・・・<br>
                            <span class="highlight">1万5千円～最大7万円くらい</span>のキャッシュバックを受けられているお客様が多いですよ♪<br><br>
                            電気ネットともに、実際切り替えると今よりどれくらいお安くなるか、CBはいくらもらえるのかっていうところを詳しくご説明させていただきたいので、<span class="highlight">明細をご準備いただき、訪問のお時間を作っていただけたら</span>と思います(*^^*)
                        </div>
                    `}
                ]
            },
            'step4': {
                title: 'STEP 4: 電気・ネット見積もり誘導',
                name: '電気・ネット案内',
                progress: 40,
                content: `
                    <div class="pattern-toggle">
                        <button class="pattern-btn active" onclick="showPattern(1)">パターン① シンプル</button>
                        <button class="pattern-btn" onclick="showPattern(2)">パターン② 詳細</button>
                    </div>
                    <div class="pattern-content active" id="pattern1">
                        <div class="talk-display">
                            撮影はグーグル認定のカメラマンがお伺いするんですが、<br>
                            今回は<span class="highlight">費用かからないご案内</span>でして、<br><br>
                            皆さんに撮影の際に一点だけいっしょにお伝えしてたのが、<br>
                            今すごく高くなってる電気の<span class="highlight">電気代支援の見積だけ</span><br>
                            電力会社さんと協力してお出ししてたんですね！
                        </div>
                    </div>
                    <div class="pattern-content" id="pattern2">
                        <div class="talk-display">
                            撮影はグーグル認定のカメラマンがお伺いするんですが、<br>
                            今回こちらのキャンペーン自体が、<span class="highlight">電力会社さんと通信会社さんと協力しての</span>ご案内になりますので<br>
                            費用は<span class="highlight">1円もかからない</span>です♪<br><br>
                            そこで みなさまに一点だけご協力いただきたいのが、<br>
                            撮影でお伺いした際に電気料金 or インターネット（お電話回線）の<br>
                            <span class="highlight">"複数社"無料見積もり</span> を取らせていただいております！
                        </div>
                    </div>
                    <div class="talk-display warning">
                        <strong>⚠️ このタイミングで決裁確認をする</strong><br>
                        <span class="talk-note">「電気やネットの契約変更はご自身でご判断できますか？」</span>
                    </div>
                `,
                choices: [
                    { text: 'わかった/進めて', sub: '→ ネット確認へ', next: 'step4b', class: 'primary' },
                    { text: 'なんで電気？', sub: '→ 切り返し表示', action: 'showHelp', helpId: 'whyElectric', class: '' },
                    { text: '決裁権がない', sub: '→ 決裁者確認', action: 'showHelp', helpId: 'noAuth', class: '' },
                    { text: '結局電気の営業でしょ？', sub: '→ 切り返し表示', action: 'showHelp', helpId: 'justElectric', class: '' }
                ],
                helps: [
                    { id: 'whyElectric', label: '「なんで電気？」', title: '「なんで電気の話なの？」への切り返し', content: `
                        <div class="modal-talk">
                            今回の撮影キャンペーン自体が、<span class="highlight">電力会社さんと通信会社さんと協力して</span>ご案内させていただいているものでして、皆さまに<span class="highlight">電気代の無料見積り</span>を取らせていただいております。<br><br>
                            それによって撮影費用を<span class="highlight">完全無料</span>でご提供できるようになっております♪
                        </div>
                        <div class="modal-note">
                            ポイント：撮影を無料にするための協賛という形で説明する
                        </div>
                    `},
                    { id: 'noAuth', label: '「決裁権がない」', title: '「決裁権がない」への対応', content: `
                        <div class="modal-talk">
                            ちなみに、電気やネットのご契約は<span class="highlight">どなたがご判断</span>されますか？<br><br>
                            （オーナー様/社長様/本部など）<br><br>
                            その方は本日いらっしゃいますか？または、お電話で確認いただくことは可能でしょうか？
                        </div>
                        <div class="modal-note">
                            ・決裁者が別にいる場合 → その方に繋いでもらう or 再架電予約<br>
                            ・本部決裁の場合 → 「本部様への確認の仕方をお伝えしますね」
                        </div>
                    `},
                    { id: 'justElectric', label: '「結局電気でしょ？」', title: '「結局目的は電気でしょ？」', content: `
                        <div class="modal-talk">
                            いえいえ(感じ良く)、私共は<span class="highlight">撮影会社</span>なので、撮影をさせていただきたいんですが、撮影自体が通常は費用がかかるものだったので、お客様からすると「リスクだ」というお声が沢山あったんですね。<br><br>
                            なのでお客様には一切費用がかからないように<span class="highlight">電気の会社さんと協力してご案内</span>をさせていただいてるんですね。
                        </div>
                        <div class="modal-note">
                            Q.「なんでそんなことできるの？」<br>
                            A. 私どもは<span class="highlight">紹介料を電力会社さんや通信会社さんから頂いて</span>まして、そちらをグーグル撮影に充てることができるので、費用を掛けずに撮影が出来るようになっております☆
                        </div>
                    `},
                    { id: 'cameraElectric', label: '「カメラマンが電気説明？」', title: '「カメラマンが電気やネットの説明をするの？」', content: `
                        <div class="modal-talk">
                            おっしゃる通りです！<br>
                            <span class="highlight">エリア担当1名</span>がお伺いさせていただいてます。<br><br>
                            グーグル認定のカメラマンですが<span class="highlight">電力会社や通信会社の取次業務もさせていただいている</span>ので、そちらの部分もご説明が可能となります。
                        </div>
                    `}
                ]
            },
            'step4b': {
                title: 'STEP 4-B: ネット利用確認',
                name: 'ネット利用確認',
                progress: 45,
                content: `
                    <div class="talk-display">
                        更新することで事業所様の情報が正確に掲載されます。<br>
                        <span class="highlight">ちなみにインターネットのご利用はございますか？</span>
                    </div>
                    <div class="talk-display tip">
                        <span class="talk-note">※利用なくても、ネット回線の契約があるか否かが重要！</span>
                    </div>
                `,
                choices: [
                    { text: 'ネット使ってる', sub: '→ 電力判別へ（電気+ネット）', next: 'step5', class: 'primary', track: { services: ['電気', 'ネット'] } },
                    { text: 'ネットは使ってない', sub: '→ 電力判別へ（電気のみ）', next: 'step5', class: '', track: { services: ['電気'] } }
                ],
                helps: []
            },
            'step5': {
                title: 'STEP 5: 電力会社判別',
                name: '電力会社判別',
                progress: 50,
                content: `
                    <div class="talk-display">
                        ちなみに、代表者様のところは<br>
                        <span class="highlight">関西電力以外のところで割引って受けられてますか？</span>
                    </div>
                `,
                choices: [
                    { text: '関西電力のまま', sub: '→ 関電向けヒアリング', next: 'step6a', class: 'primary' },
                    { text: '他の電力会社に変えてる', sub: '→ 新電力向けヒアリング', next: 'step6b', class: '' },
                    { text: 'わからない/覚えてない', sub: '→ 関電向けで進行', next: 'step6a', class: '' }
                ],
                helps: []
            },
            'step6a': {
                title: 'STEP 6-A: 関西電力ユーザー向け',
                name: '関電向けヒアリング',
                progress: 60,
                content: `
                    <div class="talk-display">
                        そうですよね！だったらちょうどよかったです！<br>
                        今、<span class="highlight">関西電力お使いの方にご案内</span>でして、<br><br>
                        電気料金に関しましては、去年の夏場から電気代があがっているため、<br>
                        ちょうど<span class="highlight">"安いね！"</span>とご実感いただける時期なんですね！<br><br>
                        どの電力会社のサービスやプランが御社様に合うか、<br>
                        弊社では<span class="highlight">複数社で横並びにして料金を比較</span>していただけまして～
                    </div>
                    <div class="talk-display tip">
                        <strong>❓ ヒアリング</strong><br>
                        2.3点ほど確認なのですが、<br>
                        電気の利用料金は、<span class="highlight">毎月だいたいおいくらくらいお支払いでしょうか？</span>
                    </div>
                `,
                choices: [
                    { text: '1万円以上', sub: '→ オール電化確認', next: 'step6c', class: 'primary' },
                    { text: '1万円以下', sub: '→ 動力確認', next: 'step6d', class: '' },
                    { text: '10万円以上/かなり高い', sub: '→ 高圧確認', next: 'step6e', class: 'warning' },
                    { text: 'わからない', sub: '→ 当て込みヒアリング', action: 'showHelp', helpId: 'guessPrice', class: '' }
                ],
                helps: [
                    { id: 'guessPrice', label: '当て込みヒアリング', title: '電気代を把握していない人への当て込み', content: `
                        <div class="modal-talk">
                            だいたいで大丈夫なのですが、<br>
                            事業所は一般家庭くらいの敷地の広さはございますか？<br>
                            （はい or それに近い）<br><br>
                            あとやっぱり朝から夕方くらいまで電気つけたり、<br>
                            夏場冬場はエアコンを使いますよね？（はい）<br><br>
                            であれば・・・・<span class="highlight">1万円は超えられている</span>かと思いますので大丈夫です♪
                        </div>
                        <div class="modal-note">→ 確認後、「1万円以上」を選択</div>
                    `},
                    { id: 'neverChanged', label: '「関電から変えたことない」', title: '「そもそも関電から替えたことがない」', content: `
                        <div class="modal-talk">
                            <strong>【スマートメータートーク】</strong><br><br>
                            そもそも安くなる理由の部分ですが、<br>
                            現在は関西電力が事業所様の<span class="highlight">メーター交換</span>をさせていただいておりますので、その場に行かなくても使用量の確認ができるようになっておりまして、その影響で<span class="highlight">検針員がまわる必要がなくなった分、人件費が大幅に削減</span>出来ております。<br><br>
                            今回ご案内しているのは、今お使いの関西電力さんの発電・送電などの電気の供給や設備は<span class="highlight">そのまま</span>で、<span class="highlight">明細発行を担当する会社が変わる</span>ってだけなんですね！
                        </div>
                    `},
                    { id: 'dontWantChange', label: '「電気変わるならいらない」', title: '「でんき変わるならいらない系」', content: `
                        <div class="modal-talk">
                            <span class="highlight">電気は変わらない</span>ですよ！<br>
                            今回ご案内しているのは今お使い関西電力さんの発電・送電などの電気の供給や設備はそのままで、「エネパル」で<span class="highlight">割引を適用するだけ</span>で電気代支援が受けることが出来るんです！
                        </div>
                        <div class="modal-note">※エネパルってなに？ → 事業所用の割引をしている新電力会社です。</div>
                    `},
                    { id: 'contractChange', label: '「契約変わるんでしょ？」', title: '「契約変わるんでしょ？」', content: `
                        <div class="modal-talk">
                            契約というよりは<span class="highlight">窓口</span>になるんですけども、<br>
                            でんきは「発電」「送電」「明細発行」の大きく3つの業務に分かれるのですが発電、送電の最も大事な部分は関西電力以外出来ないので、もちろんそのままで今回は<span class="highlight">明細発行の窓口の部分だけエネパルが担当</span>するだけで電気代支援を受けていただけます！<br><br>
                            ですのでなにかあった時の対応も供給変わらないので、関西電力さんから変わりませんのでご安心ください。
                        </div>
                    `},
                    { id: 'middleman', label: '「間に入るの嫌」', title: '「なんか間に入るん嫌や」', content: `
                        <div class="modal-talk">
                            あっ！<span class="highlight">間に入るというより役割分担</span>みたいなものでして、電気の供給は今後もずっと関電さんなので、関電さんから直で電気が送られてくるんですね！<br>
                            なので<span class="highlight">間に入りようがない</span>んですよ！
                        </div>
                    `}
                ]
            },
            'step6b': {
                title: 'STEP 6-B: 新電力ユーザー向け',
                name: '新電力向けヒアリング',
                progress: 60,
                content: `
                    <div class="talk-display">
                        そうですよね！だったらちょうどよかったです！<br>
                        今回そういった方が<span class="highlight">電気代支援の対象</span>でして、<br>
                        ちなみにどちらの会社さんでご利用でしょうか？
                    </div>
                `,
                choices: [
                    { text: '会社名を答えてくれた', sub: '→ オール電化確認', next: 'step6c', class: 'primary' },
                    { text: '覚えてない/わからない', sub: '→ 会社名確認', action: 'showHelp', helpId: 'confirmCompany', class: '' }
                ],
                helps: [
                    { id: 'confirmCompany', label: '会社名確認', title: '会社名確認トーク', content: `
                        <div class="modal-talk">
                            「ハルエネでんき」「おトクでんき」「エフエネでんき」ではなかったでしょうか？
                        </div>
                        <div class="modal-note">→ 確認できたら「会社名を答えてくれた」を選択</div>
                    `},
                    { id: 'backToKanden', label: '「関電に戻した」', title: '「新電力から関電に戻した」', content: `
                        <div class="modal-talk">
                            新電力が高騰した影響とかで関電に戻っている方も多いのですが、今って関電さんも同様の<span class="highlight">燃料調整額の値上げを上限なしで</span>行ってますので結果的にまた電気代があがってしまっている状態なんですね。<br><br>
                            ですので今回は事業所割引で高騰の影響を受けにくいように、<span class="highlight">電気の単価を調整</span>させていただけます。
                        </div>
                    `},
                    { id: 'justChanged', label: '「変えたばっかり」', title: '「変えたばっかりだから」', content: `
                        <div class="modal-talk">
                            そうですよね！最近変えられたんですかね？（いつでもOK）<br>
                            だったら問題ないですよ！<br><br>
                            今お使いの○○でんきさんで<span class="highlight">違約金が発生した場合も、キャンペーン中なので全額こちらで負担</span>するようになってますのでご安心ください☆
                        </div>
                    `},
                    { id: 'friend', label: '「知り合いで変えた」', title: '「知り合いのところだから・付き合いで変えた」', content: `
                        <div class="modal-talk">
                            そうですよね！お知り合いの方が代理店さんなんですかね？（YES）<br>
                            ちなみに<span class="highlight">最初のお支払いってもう終わってますよね？</span>（YES）<br>
                            だったら大丈夫ですよ！<br><br>
                            なぜかと言いますと、最初のお支払いが終わった時点でお知り合いの方には<span class="highlight">紹介料が振り込まれてます</span>ので今お客様がどこに変えてもその方には何の影響もないのでご安心ください☆
                        </div>
                        <div class="modal-note">※代理店に知り合いがいる場合に有効なトーク<br>※人情系は正直難しいので見切り付けて自宅案内に切り替え</div>
                    `},
                    { id: 'setDiscount', label: '「セット割がある」', title: '「ガス代、携帯代などとセット割引が付いてる」', content: `
                        <div class="modal-talk">
                            そちらなんですが、結論<span class="highlight">トータルで見ると今よりお安くなる</span>んですね！<br><br>
                            どういう事かと言うと、今回ご紹介しているパルパワーでんきに変更しますとおっしゃられてるセット割引はつかなくなってしまうんですね。<br><br>
                            ただ、その分<span class="highlight">電気料金の方に大幅に割引</span>を付けさせていただいているので結果的に合計で見ると今よりお安くなるんですよ！<br><br>
                            電気代とガス代（ケータイ代）の合計が今よりもお安くなればご問題ないですよね？☆
                        </div>
                    `}
                ]
            },
            'step6c': {
                title: 'STEP 6-C: オール電化確認',
                name: 'オール電化確認',
                progress: 65,
                content: `
                    <div class="talk-display">
                        ありがとうございます。<br>
                        <span class="highlight">オール電化やエコキュート</span>ではないでしょうか？
                    </div>
                `,
                choices: [
                    { text: 'なし', sub: '✅ 獲得可能 → 明細確認へ', next: 'step7', class: 'success' },
                    { text: 'オール電化/エコキュート/エネファームあり', sub: '→ 動力確認へ', next: 'step6d2', class: 'warning' }
                ],
                helps: []
            },
            'step6d': {
                title: 'STEP 6-D: 動力確認',
                name: '動力確認',
                progress: 65,
                content: `
                    <div class="talk-display">
                        では従量電力（100V）はお安くお使いだと思うのですが♪<br>
                        ちなみに<span class="highlight">動力（低圧電力 200V）</span>はお使いですか？
                    </div>
                    <div class="talk-display tip">
                        <span class="talk-note">💡 動力の例：業務用エアコン、冷蔵庫、食洗機、電動シャッター、コンプレッサー等</span>
                    </div>
                `,
                choices: [
                    { text: '動力使ってる', sub: '✅ 獲得可能 → 明細確認へ', next: 'step7', class: 'success' },
                    { text: '動力なし', sub: '→ オール電化確認', next: 'step6d2', class: '' }
                ],
                helps: []
            },
            'step6d2': {
                title: 'STEP 6-D-2: オール電化確認（対象外判定）',
                name: 'オール電化確認',
                progress: 65,
                content: `
                    <div class="talk-display">
                        <span class="highlight">オール電化やエコキュート</span>ではないでしょうか？
                    </div>
                `,
                choices: [
                    { text: 'なし', sub: '✅ 獲得可能（要確認）→ 明細確認へ', next: 'step7', class: 'success' },
                    { text: 'オール電化/エコキュート/エネファームあり', sub: '電気は対象外 → ネット案内へ', next: 'step8net', class: 'warning' }
                ],
                helps: []
            },
            'step6e': {
                title: 'STEP 6-E: 高圧確認',
                name: '高圧確認',
                progress: 65,
                content: `
                    <div class="talk-display">
                        <span class="highlight">キュービクル</span>（事業所の外とかに2mぐらいの白い大きい箱）はありますか？
                    </div>
                    <div class="talk-display tip">
                        <span class="talk-note">💡 高圧の可能性が高い事業所：スーパー、ゴルフ場、旅館、工場、温泉、葬祭場、教習所など</span>
                    </div>
                `,
                choices: [
                    { text: 'ある/あるかも', sub: '→ 高圧詳細ヒアリング', next: 'step6e2', class: '' },
                    { text: 'ない/わからない', sub: '✅ 獲得可能 → 明細確認へ', next: 'step7', class: 'success' }
                ],
                helps: []
            },
            'step6e2': {
                title: 'STEP 6-E-2: 高圧詳細ヒアリング',
                name: '高圧詳細ヒアリング',
                progress: 65,
                content: `
                    <div class="talk-display">
                        （ありがとうございます！）<br>
                        現在すべての電力会社が燃料高騰のあおりを受けていることや、政府の補填が終了したタイミング等は、特に電気代があがるため、いま切り替えの条件が出やすい時期なんですね！<br><br>
                        高圧お使いの場合は、<span class="highlight">直近1年分の明細（請求書）のご準備</span>をいただいております。<br>
                        毎月、電力会社さんから届く明細の保管はございますか？
                    </div>
                `,
                choices: [
                    { text: '明細ある', sub: '→ 更新月確認', action: 'showHelp', helpId: 'renewalMonth', class: 'primary' },
                    { text: '明細ない/わからない', sub: '→ 確認お願いして再架電', next: 'endRecallScheduled', class: '' }
                ],
                helps: [
                    { id: 'renewalMonth', label: '更新月確認', title: '更新月確認', content: `
                        <div class="modal-talk">
                            「ちなみに <span class="highlight">更新月はいつ頃</span>でしょうか？」
                        </div>
                        <div class="modal-note">
                            ・更新のタイミング → ✅ 獲得可能 → 明細確認へ<br>
                            ・更新月でない → 「電気はまた更新月が近づきましたら、ご提案させていただきますね！」→ ネット案内へ
                        </div>
                    `}
                ]
            },
            'step7': {
                title: 'STEP 7: 明細確認',
                name: '明細確認',
                progress: 70,
                content: `
                    <div class="talk-display">
                        ありがとうございます！<br>
                        ちなみにお料金の確認は、毎月届く <span class="highlight">紙明細（検針票）</span>ですか？<br>
                        もしくは、携帯やパソコンから <span class="highlight">WEB明細</span>でみられてますか？
                    </div>
                `,
                choices: [
                    { text: '紙明細', sub: '→ クロージングへ', next: 'step9', class: 'primary', track: { receiptType: '紙' } },
                    { text: 'WEB明細', sub: '→ ID/PW確認へ', next: 'step8web', class: '', track: { receiptType: 'WEB' } },
                    { text: 'ネットも一緒に聞きたい', sub: '→ ネット案内へ', next: 'step8net', class: '' }
                ],
                helps: []
            },
            'step8web': {
                title: 'STEP 8: WEB明細確認',
                name: 'WEB明細確認',
                progress: 75,
                content: `
                    <div class="talk-display">
                        マイページにログインするための<span class="highlight">IDとパスワード</span>はお持ちですか？
                    </div>
                    <div class="talk-display tip">
                        <strong>確認ポイント</strong><br>
                        ・ログインID（メールアドレス等）<br>
                        ・パスワード
                    </div>
                `,
                choices: [
                    { text: 'ID/PW確認OK', sub: '→ クロージングへ', next: 'step9', class: 'primary' },
                    { text: 'わからない/確認できない', sub: '→ 紙明細で案内', next: 'step9', class: '', track: { receiptType: '紙' } }
                ],
                helps: []
            },
            'step8net': {
                title: 'STEP 8: ネット・電話回線案内',
                name: 'ネット案内',
                progress: 75,
                content: `
                    <div class="talk-display">
                        電気は替えられないよー！とおっしゃるお客様には、<br>
                        <span class="highlight">通信会社さまにも協賛</span>いただいているため、<br>
                        ネット回線やお電話回線の無料見積りをみていただくことでも対応させていただいております♪<br><br>
                        インターネットに関しましては、すでにNTTでインターネットされているお客様へ、いまお使いの環境などは変わらず月々のご負担である<span class="highlight">固定費削減</span>のご提案ができます♪<br><br>
                        ちなみに、ネット回線はどちらでお繋ぎでしょうか？
                    </div>
                `,
                choices: [
                    { text: 'NTT系（フレッツ光等）', sub: '→ NTT系ヒアリング', next: 'step8netA', class: 'primary' },
                    { text: 'eo光/J:COM/ケーブル系', sub: '→ 切り替え提案', next: 'step8netB', class: '' },
                    { text: 'アナログ電話のみ', sub: '→ 光電話提案', next: 'step8netC', class: '' },
                    { text: 'わからない', sub: '→ NTT機器確認', action: 'showHelp', helpId: 'checkNtt', class: '' }
                ],
                helps: [
                    { id: 'checkNtt', label: 'NTT機器確認', title: 'ネット繋いでるけど、どこかわからない場合', content: `
                        <div class="modal-talk">
                            ・お電話機の近くに<span class="highlight">黒色のお弁当箱サイズ</span>（手のひらサイズ）のチカチカひかる機械はありますか？<br><br>
                            → ある場合：「そちらに<span class="highlight">NTTというロゴ</span>はありますか？」<br>
                            → ある →「そちらがあればNTT光回線でネットお使いです。」<br><br>
                            ・毎月NTTさんから請求書は届いてないでしょうか？<br>
                            → 届いている → NTT回線でネットお使いです
                        </div>
                        <div class="modal-note">→ 確認後、適切な選択肢を選んでください</div>
                    `}
                ]
            },
            'step8netA': {
                title: 'STEP 8-NET-A: NTT光回線系',
                name: 'NTT系ヒアリング',
                progress: 80,
                content: `
                    <div class="talk-display">
                        NTT光回線系をお使いなんですね！
                    </div>
                    <div class="talk-display tip">
                        <strong>ヒアリング項目</strong><br>
                        ・月々おいくらくらいお支払いですか？<br>
                        ・プロバイダはどちらお使いですか？<br>
                        ・普段お料金はどのように確認されてますか？<br>
                        ・明細はありますか？（紙 or WEB？）
                    </div>
                `,
                choices: [
                    { text: 'ヒアリング完了', sub: '→ クロージングへ', next: 'step9', class: 'success' },
                    { text: 'ネットもいらない', sub: '→ 対象外', next: 'endNotTarget', class: 'danger' }
                ],
                helps: []
            },
            'step8netB': {
                title: 'STEP 8-NET-B: eo光/J:COM等',
                name: 'eo光等の対応',
                progress: 80,
                content: `
                    <div class="talk-display">
                        今回はNTT光回線系のインターネット回線の案内となるんですが、<br>
                        <span class="highlight">お仕事でメールアドレスのご利用</span>ってございますでしょうか？
                    </div>
                `,
                choices: [
                    { text: 'メール使ってない', sub: '→ NTT切り替え提案', action: 'showHelp', helpId: 'nttSwitch', class: 'primary' },
                    { text: 'メール使ってる', sub: '→ 切り替え難しい', next: 'endNotTarget', class: '' }
                ],
                helps: [
                    { id: 'nttSwitch', label: 'NTT切り替え提案', title: 'NTT切り替え提案', content: `
                        <div class="modal-talk">
                            それであれば、NTTの回線をお使いいただくことで、通信費が今よりおトクにご利用いただけるかもしれませんので、実際にどのくらいお安くなるかお話を聞いていただければと思います！
                        </div>
                        <div class="modal-note">
                            Q.「工事費用や違約金は？」<br>
                            A. 今回はキャンペーンなので、すべて弊社負担です！
                        </div>
                    `}
                ]
            },
            'step8netC': {
                title: 'STEP 8-NET-C: アナログ回線',
                name: 'アナログ回線対応',
                progress: 80,
                content: `
                    <div class="talk-display">
                        アナログのお電話だけでお使いですか？<br><br>
                        ゆくゆくは<span class="highlight">アナログ回線（通常回線）が廃止</span>となるため、アナログ回線から光回線移行の案内が広まりつつあるのですがお客様のところには、NTTさんやソフトバンクさんからこういう案内のお知らせとかってもう届きましたか？？<br><br>
                        アナログでお使いいただくより、月々の基本料金も通話料もお安い<span class="highlight">光電話</span>にみなさま順々に切替えていただいてまして、弊社は今回そのご案内が可能となります！
                    </div>
                    <div class="talk-display tip">
                        <span class="talk-note">💡 NTTさんは2026年以降、光回線への切り替えをさらに進める予定です。最終的には、2030年～2035年度を目処に全国的にアナログから光への移行が完了する見込みです。</span>
                    </div>
                `,
                choices: [
                    { text: '興味ある/聞いてみる', sub: '→ ヒアリング後クロージングへ', next: 'step9', class: 'success' },
                    { text: 'いらない', sub: '→ 対象外', next: 'endNotTarget', class: '' }
                ],
                helps: [
                    { id: 'cantInstall', label: '「過去に引けないと言われた」', title: '「過去にネット引けないと言われたことがある」', content: `
                        <div class="modal-talk">
                            「なぜだめだったか」の理由にもよりますが、そのようにおっしゃるお客様って実は多いんですよ！<br><br>
                            工事担当者によって判断がさまざまだということも1つの要因なのですが、たとえば作業員の「経験値・その日のスケジュール」などによっても導入できるか否かの結果が左右されるケースが少なくないんですね。<br><br>
                            ただ弊社では、<span class="highlight">長年お付き合いのある入線専門業者さん</span>にお願いしておりますので、今まで他社さんで"難しい"とされていたお客様でも<span class="highlight">"開通できたよ☆"ってケースが多く</span>大変喜ばれています！
                        </div>
                    `}
                ]
            },
            'step9': {
                title: 'STEP 9: クロージング',
                name: 'クロージング',
                progress: 85,
                content: `
                    <div class="talk-display">
                        今回の内容を簡単にまとめると<br><br>
                        毎月お支払いの（電気料金 ／ ネット料金 ／ お電話回線の料金）が<br>
                        <span class="highlight">今よりどれくらいお安くなるか</span>見ていただけて<br><br>
                        【撮影ありの方】📷<br>
                        <span class="highlight">グーグル撮影も無料で受けていただける</span> というキャンペーンになります♪<br><br>
                        【撮影なしの方】💰<br>
                        <span class="highlight">キャッシュバックを受けていただける</span> というキャンペーンになります♪<br><br>
                        色々お伝えしましたが、今回の内容は<span class="highlight">費用は一切かからない</span>です！
                    </div>
                `,
                choices: [
                    { text: 'わかった/いいよ', sub: '→ アポ確定へ', next: 'step10', class: 'success' },
                    { text: 'ハイハイ系/反応薄い', sub: '→ 念押しトーク', action: 'showHelp', helpId: 'pushBack', class: '' },
                    { text: 'やっぱりいらない', sub: '→ 切り返し or 終了', action: 'showHelp', helpId: 'dontNeed', class: 'danger' }
                ],
                helps: [
                    { id: 'pushBack', label: 'ハイハイ系への念押し', title: 'ハイハイ系への念押しトーク', content: `
                        <div class="modal-talk">
                            「ご説明は以上になりますが、<br>
                            ここまでのキャンペーンについて<span class="highlight">ご不明点はなかったですか？</span>」と軽く念押し。
                        </div>
                        <div class="modal-note">→ 確認後「わかった/いいよ」を選択</div>
                    `},
                    { id: 'dontNeed', label: '「いらない」への対応', title: 'やっぱりいらないへの対応', content: `
                        <div class="modal-talk">
                            <strong>Q.「こっちがなんかすることあるの？・手続きめんどい系」</strong><br>
                            A. 今回、<span class="highlight">面倒なお手続きは一切ございません！</span><br>
                            同じようなご心配事をお持ちの事業者様が多くいらっしゃるのですが、実際のところ<span class="highlight">"無料サポート"でカバー</span>できておりますのでご安心ください☆
                        </div>
                    `},
                    { id: 'bankruptcy', label: '「新電力は倒産が心配」', title: '「新電力会社の倒産や事業撤退を気にしてる」', content: `
                        <div class="modal-talk">
                            そうなんですよ〜！お客様が仰る通り、ここ1.2年の燃料高騰のあおりを受けて倒産されてる会社さんもあるのですが<br><br>
                            <strong>【ハルとくの場合】</strong><br>
                            今回私どもがご紹介してるハルとくでんきは、事業所様向けに割引をご案内してる会社の中で<span class="highlight">シェアが1位</span>の会社なんですね！母体の会社も（光通信っていう）<span class="highlight">東証プライム上場</span>の大きい会社になりますので、そのあたりはみなさん安心して割引を受けていただいてます〜！
                        </div>
                    `}
                ]
            },
            'step10': {
                title: 'STEP 10: アポ確定',
                name: 'アポ確定',
                progress: 95,
                content: `
                    <div class="talk-display">
                        それではこの後、本日中に（連休明けから順番に）<br>
                        撮影部署の者から <span class="highlight">簡単なご確認・訪問の日時を決めるお電話</span>がもう一本入りますので、そちらだけご対応お願いします(*^^*)
                    </div>
                `,
                choices: [
                    { text: 'わかった', sub: '→ 名前確認へ', action: 'showHelp', helpId: 'getName', class: 'success' },
                    { text: 'このあと出掛ける/忙しい', sub: '→ 携帯番号確認', action: 'showHelp', helpId: 'getMobile', class: '' }
                ],
                helps: [
                    { id: 'getName', label: '名前確認', title: '名前確認 → 完了！', content: `
                        <div class="modal-talk">
                            私〇〇と申しますが失礼がないようにお電話口様の<span class="highlight">お名前</span>をお伺いしてよろしいですか？<br><br>
                            では〇〇様宛にお電話いたしますので、ご対応だけお願いいたします。<br>
                            では失礼致します、ありがとうございました☆<br><br>
                            <strong>（最後まで丁寧に！）</strong>
                        </div>
                        <div class="modal-note" style="background: #d3f9d8; color: #1b5e20;">→ 確認完了後、モーダルを閉じて「🎉 アポ獲得！」へ</div>
                    `},
                    { id: 'getMobile', label: '携帯番号確認', title: '携帯番号確認', content: `
                        <div class="modal-talk">
                            差し支えがなければ<span class="highlight">携帯番号</span>をお伺いできますでしょうか？<br>
                            そちらにお掛けさせていただきますね！
                        </div>
                        <div class="modal-note">※携帯の番号は、留守軽減のためなるべく聞いてください。<br>→ 確認後、名前確認へ</div>
                    `}
                ],
                nextAfterHelp: 'endSuccess'
            },
            'endSuccess': {
                title: '🎉 アポ獲得！',
                name: 'アポ獲得完了',
                progress: 100,
                isEnd: true,
                endType: 'success',
                content: `
                    <div class="end-screen success">
                        <div class="icon">🎉</div>
                        <h2>アポ受注完了！<br>お疲れ様でした</h2>
                        <div class="checklist">
                            <div class="checklist-item">☑ 会社名：___________________</div>
                            <div class="checklist-item">☑ 担当者名：___________________</div>
                            <div class="checklist-item">☑ 電話番号：___________________</div>
                            <div class="checklist-item">☑ 携帯番号：___________________</div>
                            <div class="checklist-item">☑ 案内内容：□電気 □ネット □電話回線</div>
                            <div class="checklist-item">☑ 明細：□紙 □WEB（ID/PW確認済）</div>
                            <div class="checklist-item">☑ 撮影：□あり □なし（CB案内）</div>
                        </div>
                        <div class="end-buttons">
                            <button class="end-btn primary" onclick="resetNavi()">🔄 最初から</button>
                            <a href="index.html" class="end-btn secondary" style="text-decoration:none;">📖 マニュアル</a>
                        </div>
                    </div>
                `,
                choices: [],
                helps: []
            },
            'endNotTarget': {
                title: '対象外',
                name: '対象外終了',
                progress: 100,
                isEnd: true,
                endType: 'notTarget',
                content: `
                    <div class="step-card">
                        <div class="step-title">📋 対象外</div>
                        <div class="talk-display">
                            現状どちらもお安くご利用いただいていらっしゃいますので、<br>
                            <span class="highlight">今回はご案内控えさせていただきます。</span><br>
                            お時間いただき、ありがとうございました！<br><br>
                            新たなキャンペーンが出ましたら、その時はご連絡させていただきたいと思います！<br>
                            またご機会があればお願いいたします♪<br><br>
                            <strong>（最後まで丁寧に）</strong>
                        </div>
                    </div>
                `,
                choices: [
                    { text: '🔄 最初からやり直す', next: 'step1', class: 'primary' },
                    { text: '🏠 代表者自宅案内を試す', sub: '→ 電力判別から', action: 'showHelp', helpId: 'homeOffer', class: '' }
                ],
                helps: [
                    { id: 'homeOffer', label: '自宅案内', title: '代表者自宅案内トーク', content: `
                        <div class="modal-talk">
                            「今回は代表者様の<span class="highlight">ご自宅も、特別に事業用割引のご案内が可能</span>でして〜♪」
                        </div>
                        <div class="modal-note">→ STEP 5（電力会社判別）から再開</div>
                    `}
                ]
            },
            'endRecall': {
                title: '再架電',
                name: '再架電終了',
                progress: 100,
                isEnd: true,
                endType: 'recall',
                content: `
                    <div class="step-card">
                        <div class="step-title">📞 再架電リストに追加</div>
                        <div class="talk-display tip">
                            <strong>メモ</strong><br>
                            ・会社名：___________________<br>
                            ・再架電日時：___________________<br>
                            ・備考：___________________
                        </div>
                    </div>
                `,
                choices: [
                    { text: '🔄 最初からやり直す', next: 'step1', class: 'primary' }
                ],
                helps: []
            },
            'endRecallScheduled': {
                title: '再架電予約',
                name: '再架電予約完了',
                progress: 100,
                isEnd: true,
                endType: 'recallScheduled',
                content: `
                    <div class="step-card">
                        <div class="step-title">📅 再架電予約完了</div>
                        <div class="talk-display success">
                            <strong>再架電予約を記録してください</strong><br><br>
                            ・会社名：___________________<br>
                            ・担当者名：___________________<br>
                            ・再架電日時：___________________<br>
                            ・備考：___________________
                        </div>
                    </div>
                `,
                choices: [
                    { text: '🔄 最初からやり直す', next: 'step1', class: 'primary' }
                ],
                helps: []
            }
        };

        let currentStep = 'step1';
        let history = [];
        let forwardHistory = [];
        let selectedCaller = '';
        let confirmCallback = null;

        // 架電ログ関連変数（TDZ回避のため先に宣言）
        const LOG_STORAGE_KEY = 'call_logs';
        const CALLERS_STORAGE_KEY = 'callers';
        const MAX_LOGS = 100;
        let callLogs = [];
        let callers = [];
        let currentCallData = null;
        let selectedLogIndex = null;

        // セッション変数での情報管理
        let callSession = {
            caller: '',
            company: '',
            companyType: '',
            companyTypePosition: 'before',
            phone: '',
            contactName: '',
            mobilePhone: '',
            services: [],
            receiptType: '',
            photoPreference: '',
            memo: '',
            result: '',
            recallDate: '',
            startTime: ''
        };

        function resetCallSession() {
            callSession = {
                caller: '',
                company: '',
                companyType: '',
                companyTypePosition: 'before',
                phone: '',
                contactName: '',
                mobilePhone: '',
                services: [],
                receiptType: '',
                photoPreference: '',
                memo: '',
                result: '',
                recallDate: '',
                startTime: ''
            };
        }

        function getFullCompanyName() {
            if (!callSession.companyType) return callSession.company;
            if (callSession.companyTypePosition === 'before') {
                return callSession.companyType + callSession.company;
            } else {
                return callSession.company + callSession.companyType;
            }
        }

        // フェーズ情報
        const PHASES = {
            intro: { icon: '📍', text: '導入フェーズ', task: '受付を突破する' },
            time: { icon: '⏰', text: '時間確認', task: '時間を確保する' },
            hearing: { icon: '📋', text: 'ヒアリング中', task: '情報を聞き出す' },
            explain: { icon: '💡', text: '説明フェーズ', task: 'サービスを説明する' },
            closing: { icon: '🎯', text: 'クロージング', task: 'アポを確定する' },
            end: { icon: '✅', text: '完了', task: '結果を記録する' }
        };

        function getPhaseForStep(stepId) {
            if (stepId === 'step1' || stepId === 'step1b') return PHASES.intro;
            if (stepId === 'step2') return PHASES.time;
            if (stepId.startsWith('step3') || stepId.startsWith('step4') || stepId.startsWith('step5') || stepId.startsWith('step6')) return PHASES.hearing;
            if (stepId.startsWith('step7') || stepId.startsWith('step8')) return PHASES.explain;
            if (stepId === 'step9' || stepId === 'step10') return PHASES.closing;
            return PHASES.end;
        }

        function getRemainingSteps(progress) {
            const remaining = Math.ceil((100 - progress) / 10);
            return `残り約${remaining}画面`;
        }

        function initNavi() {
            // 架電者データを先に読み込む
            const stored = localStorage.getItem(CALLERS_STORAGE_KEY);
            callers = stored ? JSON.parse(stored) : [];

            showCallerSelectScreen();
            checkTutorial();
        }

        function checkTutorial() {
            if (!localStorage.getItem('tutorial_shown')) {
                document.getElementById('tutorialOverlay').classList.add('show');
            }
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('show');
            localStorage.setItem('tutorial_shown', 'true');
        }

        function showCallerSelectScreen() {
            document.getElementById('callerSelectScreen').classList.add('visible');
            document.getElementById('stepScreen').style.display = 'none';
            document.getElementById('navBar').style.display = 'none';
            document.getElementById('floatingHelpBtn').classList.add('hidden');
            renderCallerButtons();
        }

        function renderCallerButtons() {
            const container = document.getElementById('callerButtons');
            let html = '';
            callers.forEach(c => {
                const selected = c === selectedCaller ? 'selected' : '';
                const escapedName = c.replace(/'/g, "\\'");
                html += `<button class="caller-btn ${selected}" onclick="selectCaller('${escapedName}')">
                    ${c}
                    <span class="delete-icon" onclick="event.stopPropagation(); confirmDeleteCaller('${escapedName}')">×</span>
                </button>`;
            });
            html += `<button class="caller-btn add-new" onclick="showAddCallerPrompt()">+ 新規追加</button>`;
            container.innerHTML = html;
            updateStartButton();
        }

        function confirmDeleteCaller(name) {
            if (confirm(`「${name}」さんを削除しますか？`)) {
                deleteCaller(name);
            }
        }

        function deleteCaller(name) {
            callers = callers.filter(c => c !== name);
            if (selectedCaller === name) {
                selectedCaller = '';
            }
            saveCallers();
            renderCallerButtons();
        }

        function selectCaller(name) {
            selectedCaller = name;
            renderCallerButtons();
        }

        function showAddCallerPrompt() {
            const name = prompt('新しい架電者名を入力:');
            if (name && name.trim()) {
                addCaller(name.trim());
                selectedCaller = name.trim();
                renderCallerButtons();
            }
        }

        function updateStartButton() {
            const btn = document.getElementById('startCallBtn');
            const company = document.getElementById('companyNameInput').value.trim();
            btn.disabled = !selectedCaller || !company;
        }

        function startCall() {
            // callSessionを初期化して入力値を保存
            resetCallSession();
            callSession.caller = selectedCaller;
            callSession.company = document.getElementById('companyNameInput').value.trim();
            callSession.companyType = document.getElementById('companyTypeSelect').value;
            callSession.companyTypePosition = document.getElementById('companyTypePosition').value;
            callSession.phone = document.getElementById('phoneNumberInput').value.trim();
            callSession.startTime = new Date().toISOString();

            // ヘッダーに会社情報を表示
            document.getElementById('headerCompanyName').textContent = getFullCompanyName();
            document.getElementById('headerCallMeta').textContent = callSession.phone || '';

            document.getElementById('callerSelectScreen').classList.remove('visible');
            document.getElementById('stepScreen').style.display = 'block';
            document.getElementById('navBar').style.display = 'flex';
            document.getElementById('floatingHelpBtn').classList.remove('hidden');

            history = [];
            forwardHistory = [];
            currentStep = 'step1';
            renderStep('step1');
        }

        function renderStep(stepId) {
            const step = STEPS[stepId];
            if (!step) return;

            currentStep = stepId;
            const phase = getPhaseForStep(stepId);

            // フェーズ表示更新
            document.getElementById('phaseIcon').textContent = phase.icon;
            document.getElementById('phaseText').textContent = phase.text;
            document.getElementById('taskText').textContent = phase.task;

            // 進捗更新
            const stepNum = step.title.match(/STEP (\d+)/)?.[1] || '';
            document.getElementById('stepLabel').textContent = `STEP ${stepNum}（${getRemainingSteps(step.progress)}）`;
            document.getElementById('progressFill').style.width = step.progress + '%';

            // 終了画面ではプログレス非表示
            if (step.isEnd) {
                document.getElementById('progressContainer').style.display = 'none';
            } else {
                document.getElementById('progressContainer').style.display = 'block';
            }

            // 戻る・進むボタンの状態更新と動的ラベル
            const backBtn = document.getElementById('backBtn');
            const forwardBtn = document.getElementById('forwardBtn');

            backBtn.disabled = history.length === 0;
            forwardBtn.disabled = forwardHistory.length === 0;

            if (history.length > 0) {
                backBtn.innerHTML = '← 戻る<span class="btn-count">(' + history.length + ')</span>';
            } else {
                backBtn.textContent = '← 戻る';
            }

            if (forwardHistory.length > 0) {
                forwardBtn.innerHTML = '進む →<span class="btn-count">(' + forwardHistory.length + ')</span>';
            } else {
                forwardBtn.textContent = '進む →';
            }

            // コンテンツ生成
            let html = `<div class="step-card">`;
            html += `<div class="step-title">${step.title}</div>`;

            // トークスクリプトの変換（読み上げ部分を強調）
            let content = step.content;
            content = content.replace(/\(?\^\^\)?/g, '').replace(/〜/g, '').replace(/☆/g, '').replace(/♪/g, '');

            html += content;

            // 選択肢
            if (step.choices && step.choices.length > 0) {
                const colClass = step.choices.length === 2 ? 'two-col' : '';
                html += `<div class="choices ${colClass}">`;
                step.choices.forEach((choice, index) => {
                    const classStr = choice.class || '';
                    const isEndChoice = choice.next && (choice.next.startsWith('end') || choice.class === 'danger');
                    const recommend = index === 0 && choice.class === 'primary' ? '<span class="recommend-badge">よくある回答</span>' : '';
                    const trackJson = choice.track ? JSON.stringify(choice.track).replace(/"/g, '&quot;') : '';

                    if (choice.action === 'showHelp') {
                        html += `<button class="choice-btn ${classStr}" onclick="showHelp('${choice.helpId}')">${recommend}${choice.text}${choice.sub ? `<span class="btn-sub">${choice.sub}</span>` : ''}</button>`;
                    } else if (choice.next) {
                        if (isEndChoice && !choice.next.startsWith('step')) {
                            html += `<button class="choice-btn ${classStr}" onclick="confirmEndAction('${choice.next}', '${choice.text}', ${trackJson || 'null'})">${recommend}${choice.text}${choice.sub ? `<span class="btn-sub">${choice.sub}</span>` : ''}</button>`;
                        } else {
                            if (trackJson) {
                                html += `<button class="choice-btn ${classStr}" onclick="goToStep('${choice.next}', ${trackJson})">${recommend}${choice.text}${choice.sub ? `<span class="btn-sub">${choice.sub}</span>` : ''}</button>`;
                            } else {
                                html += `<button class="choice-btn ${classStr}" onclick="goToStep('${choice.next}')">${recommend}${choice.text}${choice.sub ? `<span class="btn-sub">${choice.sub}</span>` : ''}</button>`;
                            }
                        }
                    }
                });
                html += `</div>`;
            }

            html += `</div>`;

            document.getElementById('mainContent').innerHTML = html;

            // フローティングヘルプボタン更新
            const helpBtn = document.getElementById('floatingHelpBtn');
            const helpPanelButtons = document.getElementById('helpPanelButtons');

            if (step.helps && step.helps.length > 0) {
                helpBtn.classList.remove('hidden');
                let helpHtml = '';
                step.helps.forEach(help => {
                    helpHtml += `<button class="help-btn" onclick="showHelp('${help.id}'); hideHelpPanel();">${help.label}</button>`;
                });
                helpPanelButtons.innerHTML = helpHtml;
            } else {
                helpBtn.classList.add('hidden');
            }

            window.scrollTo(0, 0);
        }

        function confirmEndAction(nextStep, actionText, trackData) {
            document.getElementById('confirmIcon').textContent = '⚠️';
            document.getElementById('confirmTitle').textContent = '確認';
            document.getElementById('confirmMessage').textContent = `「${actionText}」を選択しますか？`;
            confirmCallback = () => goToStep(nextStep, trackData);
            document.getElementById('confirmModal').classList.add('show');
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }

        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmModal();
        }

        function showHelpPanel() {
            document.getElementById('helpPanel').classList.add('show');
        }

        function hideHelpPanel() {
            document.getElementById('helpPanel').classList.remove('show');
        }

        function goToStep(stepId, trackData) {
            // トラッキングデータがあればcallSessionを更新
            if (trackData) {
                if (trackData.services) {
                    callSession.services = trackData.services;
                }
                if (trackData.addService) {
                    if (!callSession.services.includes(trackData.addService)) {
                        callSession.services.push(trackData.addService);
                    }
                }
                if (trackData.receiptType) {
                    callSession.receiptType = trackData.receiptType;
                }
                if (trackData.photoPreference) {
                    callSession.photoPreference = trackData.photoPreference;
                }
                if (trackData.result) {
                    callSession.result = trackData.result;
                }
            }
            history.push(currentStep);
            forwardHistory = [];
            renderStep(stepId);
        }

        function goBack() {
            if (history.length > 0) {
                forwardHistory.push(currentStep);
                const prevStep = history.pop();
                renderStep(prevStep);
            }
        }

        function goForward() {
            if (forwardHistory.length > 0) {
                history.push(currentStep);
                const nextStep = forwardHistory.pop();
                renderStep(nextStep);
            }
        }

        function resetNavi() {
            if (confirm('最初からやり直しますか？')) {
                resetCallSession();
                showCallerSelectScreen();
                selectedCaller = '';
                document.getElementById('companyNameInput').value = '';
                document.getElementById('phoneNumberInput').value = '';
                document.getElementById('companyTypeSelect').value = '';
                document.getElementById('companyTypePosition').value = 'before';
            }
        }

        function showHelp(helpId) {
            const step = STEPS[currentStep];
            let helpData = null;

            if (step.helps) {
                helpData = step.helps.find(h => h.id === helpId);
            }

            if (!helpData) {
                // 他のステップからも検索
                for (const key in STEPS) {
                    const s = STEPS[key];
                    if (s.helps) {
                        const found = s.helps.find(h => h.id === helpId);
                        if (found) {
                            helpData = found;
                            break;
                        }
                    }
                }
            }

            if (helpData) {
                document.getElementById('modalTitle').textContent = helpData.title;
                document.getElementById('modalBody').innerHTML = helpData.content;
                document.getElementById('modalOverlay').classList.add('show');

                // step10の場合、アポ獲得ボタンを表示
                const actionBtn = document.getElementById('modalActionBtn');
                if (currentStep === 'step10') {
                    actionBtn.style.display = 'block';
                } else {
                    actionBtn.style.display = 'none';
                }
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function closeModalAndProceed() {
            document.getElementById('modalOverlay').classList.remove('show');
            // step10からendSuccessへ遷移
            if (currentStep === 'step10') {
                goToStep('endSuccess');
            }
        }

        function showPattern(num) {
            document.querySelectorAll('.pattern-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === num - 1);
            });
            document.querySelectorAll('.pattern-content').forEach((content, i) => {
                content.classList.toggle('active', i === num - 1);
            });
        }

        // イベントリスナー
        document.getElementById('backBtn').addEventListener('click', goBack);
        document.getElementById('forwardBtn').addEventListener('click', goForward);
        document.getElementById('resetBtn').addEventListener('click', resetNavi);
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
        document.getElementById('modalActionBtn').addEventListener('click', closeModalAndProceed);
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        });

        // 架電者選択画面のイベント
        document.getElementById('companyNameInput').addEventListener('input', updateStartButton);
        document.getElementById('startCallBtn').addEventListener('click', startCall);

        // フローティングヘルプ
        document.getElementById('floatingHelpBtn').addEventListener('click', showHelpPanel);
        document.getElementById('helpPanelClose').addEventListener('click', hideHelpPanel);

        // 確認モーダル
        document.getElementById('confirmCancel').addEventListener('click', hideConfirmModal);
        document.getElementById('confirmOk').addEventListener('click', executeConfirm);

        // チュートリアル
        document.getElementById('tutorialClose').addEventListener('click', closeTutorial);

        // ========== パスワード保護（初期化）==========
        (function() {
            const CORRECT_PASSWORD = 'mix2025';
            const SESSION_KEY = 'sales_manual_auth';

            const loginScreen = document.getElementById('loginScreen');
            const appContent = document.getElementById('appContent');
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            function checkSession() {
                return sessionStorage.getItem(SESSION_KEY) === 'authenticated';
            }

            function loginSuccess() {
                sessionStorage.setItem(SESSION_KEY, 'authenticated');
                loginScreen.classList.add('hidden');
                appContent.classList.add('visible');
                initNavi();
            }

            function loginFailed() {
                loginError.classList.add('show');
                passwordInput.classList.add('error');
                passwordInput.value = '';
                passwordInput.focus();
                setTimeout(() => passwordInput.classList.remove('error'), 400);
            }

            function verifyPassword() {
                if (passwordInput.value === CORRECT_PASSWORD) {
                    loginSuccess();
                } else {
                    loginFailed();
                }
            }

            if (checkSession()) {
                loginSuccess();
            } else {
                loginScreen.classList.remove('hidden');
            }

            loginBtn.addEventListener('click', verifyPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyPassword();
            });
            passwordInput.addEventListener('input', () => {
                loginError.classList.remove('show');
            });
        })();

        // ========== 架電ログ機能 ==========
        // 初期化
        function initLogSystem() {
            loadCallers();
            loadLogs();
            updateLogBadge();
            document.getElementById('logBtn').style.display = 'block';
        }

        // 架電者管理
        function loadCallers() {
            const stored = localStorage.getItem(CALLERS_STORAGE_KEY);
            callers = stored ? JSON.parse(stored) : [];
            updateCallerDropdowns();
        }

        function saveCallers() {
            localStorage.setItem(CALLERS_STORAGE_KEY, JSON.stringify(callers));
        }

        function addCaller(name) {
            if (name && !callers.includes(name)) {
                callers.push(name);
                saveCallers();
                updateCallerDropdowns();
            }
        }

        function removeCaller(name) {
            callers = callers.filter(c => c !== name);
            saveCallers();
            updateCallerDropdowns();
        }

        function updateCallerDropdowns() {
            // フィルター用ドロップダウン
            const filterSelect = document.getElementById('logFilterCaller');
            filterSelect.innerHTML = '<option value="">全ての架電者</option>';
            callers.forEach(c => {
                filterSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }

        // ログ管理
        function loadLogs() {
            const stored = localStorage.getItem(LOG_STORAGE_KEY);
            callLogs = stored ? JSON.parse(stored) : [];
        }

        function saveLogs() {
            // 最大件数を超えたら古いものを削除
            while (callLogs.length > MAX_LOGS) {
                callLogs.shift();
            }
            localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(callLogs));
            updateLogBadge();
        }

        function updateLogBadge() {
            document.getElementById('logBadge').textContent = callLogs.length;
        }

        function addLog(logData) {
            logData.id = Date.now();
            logData.createdAt = new Date().toISOString();
            callLogs.push(logData);
            saveLogs();
        }

        function deleteLog(logId) {
            callLogs = callLogs.filter(log => log.id !== logId);
            saveLogs();
        }

        function deleteAllLogs() {
            if (confirm('すべてのログを削除しますか？\nこの操作は取り消せません。')) {
                callLogs = [];
                saveLogs();
                renderLogList();
            }
        }

        // 架電開始フォームを生成
        function generateCallStartForm() {
            return `
                <div class="call-start-form" id="callStartForm">
                    <h3>📞 架電情報を入力</h3>
                    <div class="form-row">
                        <label class="form-label">架電者名<span class="required">*</span></label>
                        <div class="form-row-inline">
                            <select class="form-input" id="callerSelect">
                                <option value="">選択してください</option>
                                ${callers.map(c => `<option value="${c}">${c}</option>`).join('')}
                                <option value="__new__">+ 新規追加</option>
                            </select>
                        </div>
                        <div id="newCallerInput" style="display: none; margin-top: 0.5rem;">
                            <div class="form-row-inline">
                                <input type="text" class="form-input" id="newCallerName" placeholder="新しい架電者名">
                                <button class="form-btn-small add" onclick="addNewCaller()">追加</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">会社名<span class="required">*</span></label>
                        <input type="text" class="form-input" id="companyName" placeholder="例：株式会社○○">
                    </div>
                    <div class="form-row">
                        <label class="form-label">電話番号</label>
                        <input type="tel" class="form-input" id="phoneNumber" placeholder="例：06-1234-5678">
                    </div>
                </div>
            `;
        }

        // 架電者選択変更時
        function onCallerSelectChange() {
            const select = document.getElementById('callerSelect');
            const newInput = document.getElementById('newCallerInput');
            if (select && newInput) {
                newInput.style.display = select.value === '__new__' ? 'block' : 'none';
            }
        }

        // 新規架電者追加
        function addNewCaller() {
            const input = document.getElementById('newCallerName');
            if (input && input.value.trim()) {
                addCaller(input.value.trim());
                const select = document.getElementById('callerSelect');
                select.innerHTML = `
                    <option value="">選択してください</option>
                    ${callers.map(c => `<option value="${c}">${c}</option>`).join('')}
                    <option value="__new__">+ 新規追加</option>
                `;
                select.value = input.value.trim();
                document.getElementById('newCallerInput').style.display = 'none';
                input.value = '';
            }
        }

        // 現在の架電データを取得
        function getCurrentCallData() {
            const callerSelect = document.getElementById('callerSelect');
            const companyName = document.getElementById('companyName');
            const phoneNumber = document.getElementById('phoneNumber');

            if (!callerSelect || !companyName) return null;

            return {
                caller: callerSelect.value === '__new__' ? '' : callerSelect.value,
                company: companyName.value.trim(),
                phone: phoneNumber ? phoneNumber.value.trim() : ''
            };
        }

        // アポ獲得用追加フォーム
        function generateSuccessForm() {
            const hasElectric = callSession.services.includes('電気');
            const hasNet = callSession.services.includes('ネット');
            const receiptPaper = callSession.receiptType === '紙' ? 'checked' : '';
            const receiptWeb = callSession.receiptType === 'WEB' ? 'checked' : '';
            const photoYes = callSession.photoPreference && callSession.photoPreference !== 'なし' ? 'checked' : '';
            const photoNo = callSession.photoPreference === 'なし' ? 'checked' : '';

            return `
                <div class="call-start-form" style="margin-top: 1rem;">
                    <!-- 自動入力済み情報 -->
                    <div class="auto-filled-section">
                        <h4>📋 自動入力済み（変更可能）</h4>
                        <div class="auto-filled-item">
                            <span class="label">会社名</span>
                            <span class="value">${getFullCompanyName()}</span>
                        </div>
                        <div class="auto-filled-item">
                            <span class="label">電話番号</span>
                            <span class="value">${callSession.phone || '未入力'}</span>
                        </div>
                        <div class="auto-filled-item">
                            <span class="label">案内内容</span>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="serviceElectric" ${hasElectric ? 'checked' : ''}> 電気</label>
                                <label><input type="checkbox" id="serviceNet" ${hasNet ? 'checked' : ''}> ネット</label>
                                <label><input type="checkbox" id="servicePhone"> 電話回線</label>
                            </div>
                        </div>
                        <div class="auto-filled-item">
                            <span class="label">明細種類</span>
                            <div class="checkbox-group">
                                <label><input type="radio" name="receiptType" value="paper" ${receiptPaper}> 紙</label>
                                <label><input type="radio" name="receiptType" value="web" ${receiptWeb}> WEB</label>
                            </div>
                        </div>
                        <div class="auto-filled-item">
                            <span class="label">撮影希望</span>
                            <div class="checkbox-group">
                                <label><input type="radio" name="photoWanted" value="yes" ${photoYes}> あり</label>
                                <label><input type="radio" name="photoWanted" value="no" ${photoNo}> なし</label>
                            </div>
                        </div>
                    </div>

                    <!-- 追加入力 -->
                    <h4 style="margin-top: 1rem;">✏️ 追加入力</h4>
                    <div class="form-row">
                        <label class="form-label">担当者名<span class="required">*</span></label>
                        <input type="text" class="form-input" id="contactName" placeholder="例：山田太郎">
                    </div>
                    <div class="form-row">
                        <label class="form-label">携帯番号（任意）</label>
                        <input type="tel" class="form-input" id="mobileNumber" placeholder="例：090-1234-5678">
                    </div>
                    <div class="form-row">
                        <label class="form-label">メモ</label>
                        <textarea class="form-input" id="successMemo" rows="3" placeholder="備考があれば入力"></textarea>
                    </div>
                    <button class="choice-btn success" onclick="saveSuccessLog()" style="width: 100%; margin-top: 1rem;">
                        📝 ログを保存して終了
                    </button>
                </div>
            `;
        }

        // 再架電・対象外用フォーム
        function generateEndForm(endType) {
            const isRecall = endType === 'recall' || endType === 'recallScheduled';
            // 終了理由のデフォルト値を設定
            let defaultReason = '';
            if (endType === 'recall' || endType === 'recallScheduled') defaultReason = '不在';
            else if (endType === 'notTarget') defaultReason = '対象外';

            return `
                <div class="call-start-form" style="margin-top: 1rem;">
                    <!-- 自動入力済み情報 -->
                    <div class="auto-filled-section">
                        <h4>📋 自動入力済み</h4>
                        <div class="auto-filled-item">
                            <span class="label">会社名</span>
                            <span class="value">${getFullCompanyName()}</span>
                        </div>
                        <div class="auto-filled-item">
                            <span class="label">電話番号</span>
                            <span class="value">${callSession.phone || '未入力'}</span>
                        </div>
                    </div>

                    <!-- 追加入力 -->
                    <h4 style="margin-top: 1rem;">✏️ 追加入力</h4>
                    <div class="form-row">
                        <label class="form-label">終了理由</label>
                        <select class="form-input" id="endReason">
                            <option value="不在" ${defaultReason === '不在' ? 'selected' : ''}>不在</option>
                            <option value="対象外" ${defaultReason === '対象外' ? 'selected' : ''}>対象外</option>
                            <option value="拒否">拒否</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    ${isRecall ? `
                    <div class="form-row">
                        <label class="form-label">再架電予定日時</label>
                        <input type="datetime-local" class="form-input" id="recallDateTime">
                    </div>
                    ` : ''}
                    <div class="form-row">
                        <label class="form-label">メモ</label>
                        <textarea class="form-input" id="endMemo" rows="3" placeholder="備考があれば入力"></textarea>
                    </div>
                    <button class="choice-btn primary" onclick="saveEndLog('${endType}')" style="width: 100%; margin-top: 1rem;">
                        📝 ログを保存して終了
                    </button>
                </div>
            `;
        }

        // アポ獲得ログを保存
        function saveSuccessLog() {
            // callSessionから基本情報を取得
            if (!callSession.caller || !callSession.company) {
                alert('架電者名と会社名は必須です');
                return;
            }

            const contactName = document.getElementById('contactName');
            if (!contactName?.value.trim()) {
                alert('担当者名は必須です');
                return;
            }

            const mobileNumber = document.getElementById('mobileNumber');
            const successMemo = document.getElementById('successMemo');

            // フォームから最新の選択値を取得（ユーザーが変更している可能性）
            const services = [];
            if (document.getElementById('serviceElectric')?.checked) services.push('電気');
            if (document.getElementById('serviceNet')?.checked) services.push('ネット');
            if (document.getElementById('servicePhone')?.checked) services.push('電話回線');

            const receiptType = document.querySelector('input[name="receiptType"]:checked')?.value || '';
            const photoWanted = document.querySelector('input[name="photoWanted"]:checked')?.value || '';

            const log = {
                caller: callSession.caller,
                company: getFullCompanyName(),
                companyType: callSession.companyType,
                phone: callSession.phone,
                result: 'success',
                resultLabel: 'アポ獲得',
                contactName: contactName.value.trim(),
                mobile: mobileNumber?.value.trim() || '',
                services: services,
                receiptType: receiptType,
                photoWanted: photoWanted,
                memo: successMemo?.value.trim() || '',
                startTime: callSession.startTime
            };

            addLog(log);
            alert('ログを保存しました！');
            showCallerSelectScreen();
        }

        // 終了ログを保存
        function saveEndLog(endType) {
            // callSessionから基本情報を取得
            if (!callSession.caller || !callSession.company) {
                alert('架電者名と会社名は必須です');
                return;
            }

            const endReason = document.getElementById('endReason');
            const recallDateTime = document.getElementById('recallDateTime');
            const endMemo = document.getElementById('endMemo');

            const resultMap = {
                'recall': { result: 'recall', label: '再架電' },
                'recallScheduled': { result: 'recall', label: '再架電予約' },
                'notTarget': { result: 'not-target', label: '対象外' }
            };

            const resultInfo = resultMap[endType] || { result: 'not-target', label: '対象外' };

            const log = {
                caller: callSession.caller,
                company: getFullCompanyName(),
                companyType: callSession.companyType,
                phone: callSession.phone,
                result: resultInfo.result,
                resultLabel: resultInfo.label,
                endReason: endReason?.value || '',
                recallDateTime: recallDateTime?.value || '',
                memo: endMemo?.value.trim() || '',
                startTime: callSession.startTime
            };

            addLog(log);
            alert('ログを保存しました！');
            showCallerSelectScreen();
        }

        // ログ一覧表示
        function showLogList() {
            renderLogList();
            document.getElementById('logListModal').classList.add('show');
        }

        function hideLogList() {
            document.getElementById('logListModal').classList.remove('show');
        }

        function getDateFilterRange(filterValue) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            switch (filterValue) {
                case 'today':
                    return { start: today, end: now };
                case 'yesterday':
                    return { start: yesterday, end: today };
                case '3days':
                    const threeDaysAgo = new Date(today);
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
                    return { start: threeDaysAgo, end: now };
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 6);
                    return { start: weekAgo, end: now };
                default:
                    return null;
            }
        }

        function formatDateHeader(date) {
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}（${days[date.getDay()]}）`;
        }

        function renderLogList() {
            const filterCaller = document.getElementById('logFilterCaller').value;
            const filterResult = document.getElementById('logFilterResult').value;
            const filterDate = document.getElementById('logFilterDate').value;

            let filteredLogs = [...callLogs].reverse();

            if (filterCaller) {
                filteredLogs = filteredLogs.filter(log => log.caller === filterCaller);
            }
            if (filterResult) {
                filteredLogs = filteredLogs.filter(log => log.result === filterResult);
            }

            const dateRange = getDateFilterRange(filterDate);
            if (dateRange) {
                filteredLogs = filteredLogs.filter(log => {
                    const logDate = new Date(log.createdAt);
                    return logDate >= dateRange.start && logDate <= dateRange.end;
                });
            }

            const body = document.getElementById('logListBody');

            if (filteredLogs.length === 0) {
                body.innerHTML = `
                    <div class="empty-logs">
                        <div class="icon">📭</div>
                        <p>ログがありません</p>
                    </div>
                `;
                return;
            }

            // 日付ごとにグループ化
            const grouped = {};
            filteredLogs.forEach(log => {
                const date = new Date(log.createdAt);
                const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { date: date, logs: [], stats: { success: 0, recall: 0, notTarget: 0 } };
                }
                grouped[dateKey].logs.push(log);
                if (log.result === 'success') grouped[dateKey].stats.success++;
                else if (log.result === 'recall') grouped[dateKey].stats.recall++;
                else grouped[dateKey].stats.notTarget++;
            });

            let html = '';
            Object.keys(grouped).forEach(dateKey => {
                const group = grouped[dateKey];
                const stats = group.stats;
                const statsStr = `アポ:${stats.success} / 再架電:${stats.recall} / 対象外:${stats.notTarget}`;

                html += `<div class="log-date-header" style="background: var(--bg-main); padding: 0.75rem 1rem; margin: 0.5rem 0; border-radius: 8px; font-size: 0.85rem;">
                    <strong>${formatDateHeader(group.date)}</strong> - ${group.logs.length}件
                    <div style="font-size: 0.75rem; color: var(--text-gray); margin-top: 0.25rem;">${statsStr}</div>
                </div>`;

                group.logs.forEach(log => {
                    const date = new Date(log.createdAt);
                    const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

                    html += `
                        <div class="log-item" onclick="showLogDetail(${log.id})">
                            <div class="log-item-header">
                                <span class="log-item-date">${timeStr}</span>
                                <span class="log-item-result ${log.result}">${log.resultLabel}</span>
                            </div>
                            <div class="log-item-company">${log.company}</div>
                            <div class="log-item-caller">架電者：${log.caller}</div>
                        </div>
                    `;
                });
            });

            body.innerHTML = html;
        }

        // ログ詳細表示
        function showLogDetail(logId) {
            const log = callLogs.find(l => l.id === logId);
            if (!log) return;

            selectedLogIndex = logId;

            const date = new Date(log.createdAt);
            const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

            let detailHtml = `
                <div class="log-detail-section">
                    <h4>基本情報</h4>
                    <div class="log-detail-row">
                        <span class="label">架電日時</span>
                        <span class="value">${dateStr}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="label">架電者</span>
                        <span class="value">${log.caller}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="label">会社名</span>
                        <span class="value">${log.company}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="label">電話番号</span>
                        <span class="value">${log.phone || '-'}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="label">結果</span>
                        <span class="value">${log.resultLabel}</span>
                    </div>
                </div>
            `;

            if (log.result === 'success') {
                detailHtml += `
                    <div class="log-detail-section">
                        <h4>アポ情報</h4>
                        <div class="log-detail-row">
                            <span class="label">担当者名</span>
                            <span class="value">${log.contactName || '-'}</span>
                        </div>
                        <div class="log-detail-row">
                            <span class="label">携帯番号</span>
                            <span class="value">${log.mobile || '-'}</span>
                        </div>
                        <div class="log-detail-row">
                            <span class="label">案内内容</span>
                            <span class="value">${log.services?.join(', ') || '-'}</span>
                        </div>
                        <div class="log-detail-row">
                            <span class="label">明細種類</span>
                            <span class="value">${log.receiptType === 'paper' ? '紙明細' : log.receiptType === 'web' ? 'WEB明細' : '-'}</span>
                        </div>
                        <div class="log-detail-row">
                            <span class="label">撮影希望</span>
                            <span class="value">${log.photoWanted === 'yes' ? 'あり' : log.photoWanted === 'no' ? 'なし' : '-'}</span>
                        </div>
                    </div>
                `;
            } else {
                detailHtml += `
                    <div class="log-detail-section">
                        <h4>終了情報</h4>
                        <div class="log-detail-row">
                            <span class="label">終了理由</span>
                            <span class="value">${log.endReason || '-'}</span>
                        </div>
                        ${log.recallDateTime ? `
                        <div class="log-detail-row">
                            <span class="label">再架電予定</span>
                            <span class="value">${log.recallDateTime.replace('T', ' ')}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            if (log.memo) {
                detailHtml += `
                    <div class="log-detail-section">
                        <h4>メモ</h4>
                        <div class="log-detail-memo">${log.memo}</div>
                    </div>
                `;
            }

            detailHtml += `
                <div class="log-detail-actions">
                    <button class="log-detail-btn image" onclick="downloadLogImage(${log.id})">📷 画像保存</button>
                    <button class="log-detail-btn delete" onclick="deleteLogConfirm(${log.id})">🗑️ 削除</button>
                </div>
            `;

            document.getElementById('logDetailContent').innerHTML = detailHtml;
            document.getElementById('logDetailModal').classList.add('show');
        }

        function hideLogDetail() {
            document.getElementById('logDetailModal').classList.remove('show');
        }

        function deleteLogConfirm(logId) {
            if (confirm('このログを削除しますか？')) {
                deleteLog(logId);
                hideLogDetail();
                renderLogList();
            }
        }

        // CSVダウンロード（フィルター対応）
        function downloadCsv() {
            const filterCaller = document.getElementById('logFilterCaller').value;
            const filterResult = document.getElementById('logFilterResult').value;
            const filterDate = document.getElementById('logFilterDate').value;

            let logsToExport = [...callLogs];

            if (filterCaller) {
                logsToExport = logsToExport.filter(log => log.caller === filterCaller);
            }
            if (filterResult) {
                logsToExport = logsToExport.filter(log => log.result === filterResult);
            }

            const dateRange = getDateFilterRange(filterDate);
            if (dateRange) {
                logsToExport = logsToExport.filter(log => {
                    const logDate = new Date(log.createdAt);
                    return logDate >= dateRange.start && logDate <= dateRange.end;
                });
            }

            if (logsToExport.length === 0) {
                alert('ダウンロードするログがありません');
                return;
            }

            const headers = ['日時', '架電者', '会社名', '電話番号', '結果', '担当者名', '携帯番号', '案内内容', '明細種類', '撮影希望', '終了理由', '再架電予定', 'メモ'];

            const rows = logsToExport.map(log => {
                const date = new Date(log.createdAt);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

                return [
                    dateStr,
                    log.caller || '',
                    log.company || '',
                    log.phone || '',
                    log.resultLabel || '',
                    log.contactName || '',
                    log.mobile || '',
                    log.services?.join('/') || '',
                    log.receiptType === 'paper' ? '紙' : log.receiptType === 'web' ? 'WEB' : '',
                    log.photoWanted === 'yes' ? 'あり' : log.photoWanted === 'no' ? 'なし' : '',
                    log.endReason || '',
                    log.recallDateTime ? log.recallDateTime.replace('T', ' ') : '',
                    log.memo || ''
                ].map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
            });

            const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // ファイル名に期間を含める
            const today = new Date();
            const formatDate = d => `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
            let fileName;

            if (dateRange) {
                fileName = `架電ログ_${formatDate(dateRange.start)}_${formatDate(dateRange.end)}.csv`;
            } else {
                fileName = `架電ログ_全期間_${formatDate(today)}.csv`;
            }

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // 画像ダウンロード
        async function downloadLogImage(logId) {
            const log = callLogs.find(l => l.id === logId);
            if (!log) return;

            const date = new Date(log.createdAt);
            const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

            document.getElementById('captureDate').textContent = dateStr;

            let bodyHtml = `
                <div class="log-capture-row"><span>架電者</span><span>${log.caller}</span></div>
                <div class="log-capture-row"><span>会社名</span><span>${log.company}</span></div>
                <div class="log-capture-row"><span>電話番号</span><span>${log.phone || '-'}</span></div>
                <div class="log-capture-row"><span>結果</span><span>${log.resultLabel}</span></div>
            `;

            if (log.result === 'success') {
                bodyHtml += `
                    <div class="log-capture-row"><span>担当者名</span><span>${log.contactName || '-'}</span></div>
                    <div class="log-capture-row"><span>携帯番号</span><span>${log.mobile || '-'}</span></div>
                    <div class="log-capture-row"><span>案内内容</span><span>${log.services?.join(', ') || '-'}</span></div>
                    <div class="log-capture-row"><span>明細種類</span><span>${log.receiptType === 'paper' ? '紙明細' : log.receiptType === 'web' ? 'WEB明細' : '-'}</span></div>
                    <div class="log-capture-row"><span>撮影希望</span><span>${log.photoWanted === 'yes' ? 'あり' : log.photoWanted === 'no' ? 'なし' : '-'}</span></div>
                `;
            } else {
                bodyHtml += `
                    <div class="log-capture-row"><span>終了理由</span><span>${log.endReason || '-'}</span></div>
                `;
                if (log.recallDateTime) {
                    bodyHtml += `<div class="log-capture-row"><span>再架電予定</span><span>${log.recallDateTime.replace('T', ' ')}</span></div>`;
                }
            }

            if (log.memo) {
                bodyHtml += `<div class="log-capture-row" style="flex-direction: column; align-items: flex-start;"><span style="margin-bottom: 0.25rem;">メモ</span><span style="white-space: pre-wrap;">${log.memo}</span></div>`;
            }

            document.getElementById('captureBody').innerHTML = bodyHtml;

            // Move capture area into view for rendering
            const captureEl = document.getElementById('logCapture');
            captureEl.style.left = '0';

            try {
                const canvas = await html2canvas(captureEl, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });

                captureEl.style.left = '-9999px';

                const link = document.createElement('a');
                link.download = `架電記録_${log.company}_${date.getMonth() + 1}${date.getDate()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                captureEl.style.left = '-9999px';
                alert('画像の生成に失敗しました');
                console.error(err);
            }
        }

        // renderStepを拡張してフォームを追加
        const originalRenderStep = renderStep;
        renderStep = function(stepId) {
            originalRenderStep(stepId);

            const step = STEPS[stepId];
            if (!step) return;

            const mainContent = document.getElementById('mainContent');

            // step1の場合、架電開始フォームを追加
            if (stepId === 'step1') {
                mainContent.innerHTML = generateCallStartForm() + mainContent.innerHTML;
                // イベントリスナーを追加
                setTimeout(() => {
                    const select = document.getElementById('callerSelect');
                    if (select) {
                        select.addEventListener('change', onCallerSelectChange);
                    }
                }, 0);
            }

            // 終了画面の場合、適切なフォームを追加
            if (step.isEnd) {
                if (step.endType === 'success') {
                    mainContent.innerHTML += generateSuccessForm();
                } else if (step.endType === 'recall' || step.endType === 'recallScheduled' || step.endType === 'notTarget') {
                    mainContent.innerHTML += generateEndForm(step.endType);
                }
            }
        };

        // ログ関連イベントリスナー
        document.getElementById('logBtn').addEventListener('click', showLogList);
        document.getElementById('logListClose').addEventListener('click', hideLogList);
        document.getElementById('logDetailClose').addEventListener('click', hideLogDetail);
        document.getElementById('logDownloadCsv').addEventListener('click', downloadCsv);
        document.getElementById('logDeleteAll').addEventListener('click', deleteAllLogs);
        document.getElementById('logFilterCaller').addEventListener('change', renderLogList);
        document.getElementById('logFilterResult').addEventListener('change', renderLogList);
        document.getElementById('logFilterDate').addEventListener('change', renderLogList);

        document.getElementById('logListModal').addEventListener('click', (e) => {
            if (e.target.id === 'logListModal') hideLogList();
        });
        document.getElementById('logDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'logDetailModal') hideLogDetail();
        });

        // ログシステム初期化
        initLogSystem();
    </script>
</body>
</html>
